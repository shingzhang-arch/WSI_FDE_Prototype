<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Picks Carousel - Preview</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@salesforce-ux/design-system@2.25.0/assets/styles/salesforce-lightning-design-system.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f3f3;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== LEFT PANEL ===== */
        .settings-panel {
            width: 280px;
            min-width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e5e5;
            padding: 1.25rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .panel-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: #181818;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #181818;
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .panel-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: #706e6b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-option {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s;
            border: 1px solid transparent;
        }

        .panel-option:hover {
            background-color: #f3f3f3;
        }

        .panel-option.selected {
            background-color: #eef4ff;
            border-color: #0176d3;
        }

        .panel-option input[type="radio"] {
            margin-top: 2px;
            accent-color: #0176d3;
            flex-shrink: 0;
        }

        .panel-option-content {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .panel-option-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #181818;
        }

        .panel-option-desc {
            font-size: 0.6875rem;
            color: #706e6b;
            line-height: 1.4;
        }

        .panel-divider {
            height: 1px;
            background-color: #e5e5e5;
        }

        .panel-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
        }

        .panel-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #0176d3;
            cursor: pointer;
        }

        .panel-toggle-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #181818;
        }

        /* ===== PROTOTYPE FOOTER TOGGLE ===== */
        .panel-proto-footer {
            flex-shrink: 0;
        }
        .panel-proto-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0.25rem;
            cursor: pointer;
        }
        .panel-proto-toggle-label {
            font-size: 0.8125rem;
            font-weight: 700;
            color: #181818;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #c9c9c9;
            transition: 0.2s;
            border-radius: 22px;
        }
        .toggle-slider::before {
            content: "";
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: 0.2s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #0176d3;
        }
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(18px);
        }
        .panel-device-options {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            padding-top: 0.5rem;
        }

        /* ===== RIGHT PREVIEW AREA ===== */
        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
            background-color: #f3f3f3;
        }

        .preview-container {
            max-width: 375px;
            width: 100%;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        #standaloneContainer {
            position: relative;
        }

        /* ===== HEADER ===== */
        .header {
            margin-bottom: 0.75rem;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.25rem;
        }

        .header h2 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #181818;
            margin: 0;
        }

        .header p {
            font-size: 0.875rem;
            color: #706e6b;
        }

        /* See More: Variation A - Header Right Link */
        .see-more-link {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #0176d3;
            text-decoration: none;
            white-space: nowrap;
            cursor: pointer;
            pointer-events: auto;
        }
        .see-more-link:hover {
            text-decoration: underline;
        }
        .see-more-link.is-hidden {
            pointer-events: none;
        }

        /* See More: Variation B - Full-Width Button */
        .see-more-button-full {
            display: block;
            width: 100%;
            padding: 0.625rem;
            margin-top: 0.75rem;
            background: transparent;
            border: 1px solid #181818;
            color: #181818;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.15s;
        }
        .see-more-button-full:hover {
            background-color: #181818;
            color: #ffffff;
        }

        /* See More: Variation C - Card in Carousel */
        .see-more-card {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .see-more-card-inner {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 1px solid #e5e5e5;
            border-radius: 0;
            background-color: #fafaf9;
            transition: box-shadow 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            text-align: center;
        }
        .see-more-card-inner:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background-color: #f3f3f3;
        }
        .see-more-card-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0176d3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .see-more-card-icon {
            font-size: 1.5rem;
            color: #0176d3;
            margin-bottom: 0.5rem;
        }


        /* Utility class to hide elements */
        .is-hidden {
            display: none !important;
        }

        /* ===== CAROUSEL ===== */
        .carousel-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .carousel-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .carousel-track {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            overflow: hidden;
        }

        .product-card {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .product-card-inner {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 1px solid #e5e5e5;
            border-radius: 0;
            background-color: #ffffff;
            transition: box-shadow 0.2s ease;
        }

        .product-card-inner:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .product-badge {
            position: absolute;
            top: 0.375rem;
            left: 0.375rem;
            display: flex;
            align-items: center;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            z-index: 1;
        }

        .badge-olive-pick {
            background-color: #2e844a;
        }

        .badge-best-seller {
            background-color: #0176d3;
        }

        .badge-top-rated {
            background-color: #fe9339;
        }

        .badge-text {
            font-size: 0.5625rem;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .product-image-container {
            width: 100%;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fafaf9;
            overflow: hidden;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
        }

        .product-name {
            font-weight: 600;
            color: #181818;
            line-height: 1.3;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .price-text {
            font-weight: 400;
            color: #181818;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .btn {
            padding: 0.5rem;
            border-radius: 4px;
            border: none;
            font-size: 0.6875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-quick-view {
            background-color: transparent;
            color: #0176d3;
            border: 1px solid #0176d3;
            text-transform: uppercase;
            text-align: center;
            display: block;
            letter-spacing: 0.5px;
            font-weight: 600;
            border-radius: 0;
        }
        .btn-quick-view:hover {
            background-color: #0176d3;
            color: white;
        }

        .btn-shop-now {
            background-color: #181818;
            color: white;
            text-transform: uppercase;
            text-decoration: none;
            text-align: center;
            display: block;
            letter-spacing: 0.5px;
            font-weight: 600;
            border-radius: 0;
        }
        .btn-shop-now:hover {
            background-color: #333333;
        }

        .carousel-nav {
            flex-shrink: 0;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 1.5rem;
            color: #181818;
            padding: 0.5rem;
            line-height: 1;
        }
        .carousel-nav:hover:not(:disabled) { opacity: 0.7; }
        .carousel-nav:disabled { color: #c9c9c9; cursor: not-allowed; }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: none;
            background-color: #c9c9c9;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 0;
            flex-shrink: 0;
        }
        .pagination-dot:hover:not(.active) { background-color: #a0a0a0; }
        .pagination-dot.active { background-color: #181818; }

        /* ===== DISCLOSURE AREAS ===== */

        /* Disclosure 1: Expand Grid Below */
        .expanded-grid {
            display: none;
            margin-top: 1rem;
            border-top: 1px solid #e5e5e5;
            padding-top: 0.75rem;
        }
        .expanded-grid.visible {
            display: block;
        }
        .expanded-grid-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #706e6b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.5rem;
        }
        .expanded-grid-track {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        /* ===== CONVERSATION NUDGE CHIPS ===== */
        .nudge-chips-container {
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e5e5;
        }
        .nudge-chips-container.visible {
            display: flex;
        }
        .nudge-chips-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: #706e6b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .nudge-chips-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }
        .nudge-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.625rem;
            border-radius: 100px;
            border: 1px solid #c9c7c5;
            background: #ffffff;
            color: #181818;
            font-size: 0.6875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            text-decoration: none;
        }
        .nudge-chip:hover {
            background-color: #f3f3f3;
            border-color: #706e6b;
        }
        .nudge-chip.active {
            background-color: #0176d3;
            border-color: #0176d3;
            color: #ffffff;
        }
        .nudge-chip-icon {
            font-size: 0.75rem;
            line-height: 1;
        }
        .nudge-chip.accent {
            background-color: #eef4ff;
            border-color: #0176d3;
            color: #0176d3;
        }
        .nudge-chip.accent:hover {
            background-color: #0176d3;
            color: #ffffff;
        }
        .nudge-chip:disabled {
            opacity: 0.45;
            cursor: default;
            pointer-events: none;
        }
        .nudge-chip.selected {
            background-color: #181818;
            border-color: #181818;
            color: #ffffff;
            pointer-events: none;
        }

        /* ===== CONVERSATION THREAD (appended turns) ===== */
        .conversation-thread {
            display: flex;
            flex-direction: column;
        }
        .conversation-turn {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e5e5;
            animation: turnSlideIn 0.35s ease-out both;
        }
        @keyframes turnSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .turn-commentary {
            font-size: 0.8125rem;
            color: #181818;
            line-height: 1.5;
            margin-bottom: 0.625rem;
        }
        .turn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        .turn-nudge-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.625rem;
            padding-top: 0.5rem;
        }
        .turn-nudge-label {
            width: 100%;
            font-size: 0.6875rem;
            font-weight: 600;
            color: #706e6b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.125rem;
        }
        .turn-list {
            max-height: 320px;
            overflow-y: auto;
        }
        .turn-carousel {
            margin-bottom: 0.25rem;
        }

        /* Disclosure 4: Scrollable List */
        .scrollable-list {
            display: none;
            margin-top: 0rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .scrollable-list.visible {
            display: block;
        }
        .list-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
            text-decoration: none;
            color: inherit;
            transition: background 0.1s;
        }
        .list-item:hover {
            background-color: #fafaf9;
        }
        .list-item-img {
            width: 52px;
            height: 52px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #fafaf9;
        }
        .list-item-info {
            flex: 1;
            min-width: 0;
        }
        .list-item-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #181818;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-item-price {
            font-size: 0.6875rem;
            color: #706e6b;
            margin-top: 0.125rem;
        }
        .list-item-arrow {
            color: #c9c9c9;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        /* Disclosure 5: Stacked Carousels */
        .stacked-carousels {
            display: none;
            margin-top: 1rem;
            border-top: 1px solid #e5e5e5;
            padding-top: 0.75rem;
        }
        .stacked-carousels.visible {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .sub-carousel-header {
            font-size: 0.875rem;
            font-weight: 700;
            color: #181818;
            margin-bottom: 0.5rem;
        }
        .sub-carousel-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .sub-carousel-track {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            flex: 1;
        }
        .sub-carousel-nav-btn {
            flex-shrink: 0;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            color: #181818;
            padding: 0.25rem;
            transition: opacity 0.2s;
        }
        .sub-carousel-nav-btn:hover:not(:disabled) {
            opacity: 0.7;
        }
        .sub-carousel-nav-btn:disabled {
            color: #c9c9c9;
            cursor: not-allowed;
        }
        .sub-carousel-nav {
            display: flex;
            justify-content: center;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        .sub-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            border: none;
            background-color: #c9c9c9;
            padding: 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sub-dot:hover:not(.active) {
            background-color: #a0a0a0;
        }
        .sub-dot.active { 
            background-color: #181818; 
        }

        /* Carousel section that hides/shows */
        .carousel-section {
            /* visible by default */
        }
        .carousel-section.hidden {
            display: none;
        }

        /* ===== CHAT INTERFACE ===== */
        .prototype-mode {
            background-color: #f8f9fa;
        }

        .chat-container {
            max-width: 375px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            min-height: 100%;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            animation: messageSlideIn 0.3s ease-out;
            opacity: 0;
            transform: translateY(10px);
        }

        .chat-message.visible {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.agent {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .chat-message.user .message-bubble {
            background-color: #0176d3;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        .chat-message.agent .message-bubble {
            background-color: #ffffff;
            color: #181818;
            border: 1px solid #e5e5e5;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .message-text {
            font-size: 0.875rem;
            line-height: 1.4;
            margin: 0;
        }

        .message-time {
            font-size: 0.6875rem;
            color: #706e6b;
            padding: 0 0.5rem;
        }

        .chat-message.agent {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            background-color: transparent;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .chat-message.agent .message-content .preview-container {
            margin: 0;
            box-shadow: none;
            border: none;
            padding: 0;
        }

        /* ===== PHONE FRAME (Mobile Prototype) ===== */
        .phone-frame {
            display: none;
            justify-content: center;
        }
        .phone-bezel {
            width: 393px;
            background: #1d1d1f;
            border-radius: 50px;
            padding: 10px;
            position: relative;
            box-shadow: 0 0 0 1px #3a3a3c, 0 25px 70px rgba(0,0,0,0.35);
        }
        .phone-dynamic-island {
            position: absolute;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 126px;
            height: 37px;
            background: #000;
            border-radius: 20px;
            z-index: 10;
        }
        .phone-screen {
            background: #f8f9fa;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 780px;
            padding-top: 52px;
            position: relative;
        }
        .phone-screen-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .phone-screen-body::-webkit-scrollbar { display: none; }
        .phone-screen-body { -ms-overflow-style: none; scrollbar-width: none; }
        .phone-home-indicator-wrap {
            display: flex;
            justify-content: center;
            padding: 6px 0 4px;
            background: #1d1d1f;
        }
        .phone-home-indicator {
            width: 134px;
            height: 5px;
            background: #555;
            border-radius: 3px;
        }
        .phone-screen .chat-container {
            max-width: 100%;
            border-radius: 0;
            min-height: 100%;
            background: #f8f9fa;
        }
        .mobile-input-bar {
            flex-shrink: 0;
            padding: 0.5rem 0.75rem;
            background: #fff;
            border-top: 1px solid #e5e5e5;
            border-radius: 0 0 40px 40px;
        }
        .mobile-input-field {
            width: 100%;
            padding: 0.5rem 0.875rem;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 0.8125rem;
            color: #706e6b;
            background: #fff;
            outline: none;
            font-family: inherit;
        }
        .mobile-input-field:focus {
            border-color: #0176d3;
        }

        /* ===== DESKTOP BROWSER FRAME ===== */
        .desktop-frame {
            display: none;
            flex-direction: column;
            width: 1100px;
            max-width: calc(100vw - 320px);
            height: calc(100vh - 1.5rem);
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 12px 48px rgba(0,0,0,0.18);
        }
        .browser-chrome {
            height: 40px;
            background: linear-gradient(180deg, #e8e8e8, #d8d8d8);
            display: flex;
            align-items: center;
            padding: 0 14px;
            gap: 10px;
            border-bottom: 1px solid #c0c0c0;
            flex-shrink: 0;
        }
        .browser-dots {
            display: flex;
            gap: 7px;
        }
        .browser-dots .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .browser-dots .dot.red { background: #ff5f57; }
        .browser-dots .dot.yellow { background: #ffbd2e; }
        .browser-dots .dot.green { background: #28c840; }
        .browser-url-bar {
            flex: 1;
            max-width: 420px;
            height: 26px;
            background: #ffffff;
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.75rem;
            color: #555;
            gap: 5px;
            margin-left: 4px;
            border: 1px solid #c0c0c0;
        }
        .browser-url-bar .lock-icon {
            font-size: 0.625rem;
            color: #2e844a;
        }
        .browser-viewport {
            display: flex;
            flex: 1;
            min-height: 0;
            position: relative;
        }

        /* ===== WS MOCKUP (Desktop left side) ===== */
        .ws-mockup {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            font-family: Georgia, 'Times New Roman', serif;
            position: relative;
        }
        .ws-mockup::-webkit-scrollbar { width: 6px; }
        .ws-mockup::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 3px; }
        .ws-promo-bar {
            background: #2d2d2d;
            color: #fff;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.625rem;
            letter-spacing: 1px;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .ws-main-header {
            padding: 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid #e0ddd8;
        }
        .ws-logo-text {
            font-size: 1.125rem;
            font-weight: 400;
            letter-spacing: 4px;
            color: #2d2d2d;
        }
        .ws-nav-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1.25rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0ddd8;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.625rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: #2d2d2d;
        }
        .ws-nav-bar span {
            cursor: default;
        }
        .ws-nav-bar .ws-nav-active {
            color: #2e844a;
            border-bottom: 2px solid #2e844a;
            padding-bottom: 2px;
        }
        .ws-hero {
            height: 280px;
            background: linear-gradient(135deg, #e8e5de 0%, #d4cfc6 50%, #c7c0b5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .ws-hero-overlay { padding: 2rem; }
        .ws-hero-title {
            font-size: 1.75rem;
            font-weight: 400;
            letter-spacing: 3px;
            color: #2d2d2d;
            margin-bottom: 0.5rem;
        }
        .ws-hero-subtitle {
            font-size: 0.8125rem;
            color: #555;
            margin-bottom: 1.25rem;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .ws-hero-cta {
            background: #2d2d2d;
            color: #fff;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: 1.5px;
            cursor: default;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .ws-section {
            padding: 1.5rem;
        }
        .ws-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 2px;
            color: #2d2d2d;
            text-align: center;
            margin-bottom: 1rem;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .ws-category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        .ws-category-card {
            aspect-ratio: 4/3;
            background: linear-gradient(145deg, #f5f3ef, #e8e5de);
            border: 1px solid #e0ddd8;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 0.75rem;
        }
        .ws-category-card span {
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: #2d2d2d;
            text-transform: uppercase;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .ws-product-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            padding: 0 1.5rem 1.5rem;
        }
        .ws-product-mock {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .ws-product-mock-img {
            aspect-ratio: 1;
            background: linear-gradient(145deg, #f5f3ef, #ebe8e2);
            border: 1px solid #e0ddd8;
        }
        .ws-product-mock-name {
            height: 10px;
            background: #e0ddd8;
            border-radius: 2px;
            width: 85%;
        }
        .ws-product-mock-price {
            height: 8px;
            background: #d0cdc8;
            border-radius: 2px;
            width: 40%;
        }

        /* ===== DESKTOP SIDEBAR (Chat Widget) ===== */
        .desktop-sidebar {
            width: 360px;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #c0c0c0;
            background: #f9fafb;
            flex-shrink: 0;
            box-shadow: -6px 0 24px rgba(0,0,0,0.12);
            position: relative;
            z-index: 2;
            overflow: hidden;
        }
        .chat-header-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.75rem;
            background: #1a1a1a;
            flex-shrink: 0;
            position: relative;
        }
        .chat-header-sparkle {
            font-size: 1rem;
            color: #fff;
            flex-shrink: 0;
        }
        .chat-header-brand-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            display: none;
        }
        .chat-header-brand-name {
            flex: 1;
            font-size: 0.9375rem;
            font-weight: 700;
            color: #ffffff;
            white-space: nowrap;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .chat-header-btn {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: #ffffff;
            font-size: 1.25rem;
            line-height: 1;
            transition: background 0.15s;
        }
        .chat-header-btn:hover {
            background: rgba(255,255,255,0.12);
        }
        /* "End Chat" dropdown */
        .chat-header-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0.75rem;
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            z-index: 100;
            overflow: hidden;
            min-width: 140px;
        }
        .chat-header-menu.visible {
            display: block;
        }
        .chat-header-menu-item {
            padding: 0.625rem 1rem;
            color: #ffffff;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: background 0.12s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .chat-header-menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        /* Minimized state (just the Olive icon) */
        .chat-minimized-fab {
            display: none;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: #2e844a;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            transition: transform 0.15s;
        }
        .chat-minimized-fab:hover {
            transform: scale(1.08);
        }
        .chat-minimized-fab img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        /* Legacy alias kept for sidebar compat */
        .sidebar-brand-icon { display: none; }
        .desktop-sidebar .chat-container {
            max-width: 100%;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            border-radius: 0;
            background: #ffffff;
        }
        .sidebar-input-bar {
            flex-shrink: 0;
            padding: 0.625rem 0.75rem;
            background: #fff;
            border-top: 1px solid #e5e5e5;
        }
        .sidebar-input-field {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 0.8125rem;
            color: #706e6b;
            background: #fff;
            outline: none;
            font-family: inherit;
        }
        .sidebar-input-field:focus {
            border-color: #0176d3;
        }

        

        /* WS sister brands bar */
        .ws-brands-bar {
            display: flex;
            justify-content: center;
            gap: 1.25rem;
            padding: 0.375rem 1rem;
            border-bottom: 1px solid #e0ddd8;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.5625rem;
            color: #706e6b;
        }
        .ws-brands-bar span.ws-brand-active {
            color: #2d2d2d;
            font-weight: 700;
            text-decoration: underline;
        }

        /* WS join bar */
        .ws-join-bar {
            background: #f5f3ef;
            text-align: center;
            padding: 0.375rem;
            font-size: 0.5625rem;
            color: #2d2d2d;
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            border-bottom: 1px solid #e0ddd8;
        }
        .ws-join-bar a {
            color: #0176d3;
            text-decoration: none;
            font-weight: 600;
        }

        /* ===== PREVIEW AREA DEVICE OVERRIDES ===== */
        .preview-area.device-desktop {
            flex-direction: row;
            padding: 0.75rem;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .preview-area.device-mobile {
            flex-direction: row;
            justify-content: center;
        }

        /* ===== RIGHT RAIL (UX Commentary) ===== */
        .ux-rail {
            width: 340px;
            min-width: 340px;
            background: #ffffff;
            border-left: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            transition: width 0.25s ease, min-width 0.25s ease;
            overflow: hidden;
            position: relative;
        }
        .ux-rail.is-hidden {
            display: none;
        }
        .ux-rail.collapsed {
            width: 40px;
            min-width: 40px;
            border-left: 1px solid #e5e5e5;
        }
        .ux-rail.collapsed .ux-rail-header,
        .ux-rail.collapsed .ux-rail-body {
            display: none;
        }
        .ux-rail-toggle {
            width: 100%;
            height: 40px;
            background: #ffffff;
            border: none;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #706e6b;
            font-size: 0.875rem;
            transition: background 0.15s;
            flex-shrink: 0;
        }
        .ux-rail-toggle:hover {
            background: #f3f3f3;
            color: #181818;
        }
        .ux-rail.collapsed .ux-rail-toggle {
            border-bottom: none;
            height: 48px;
        }
        .ux-rail-header {
            padding: 1rem 1.25rem 0.75rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .ux-rail-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: #181818;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ux-rail-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.25rem;
        }
        .ux-explanations {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .ux-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 1.125rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e5e5;
        }
        .ux-card-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-bottom: 0.625rem;
            flex-wrap: wrap;
        }
        .ux-card-icon {
            font-size: 1.1rem;
            line-height: 1;
        }
        .ux-card-title {
            font-size: 0.8125rem;
            font-weight: 700;
            color: #181818;
        }
        .ux-card-label {
            font-size: 0.5625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.125rem 0.4375rem;
            border-radius: 4px;
            margin-left: auto;
        }
        .ux-card-label.placement { background: #eef4ff; color: #0176d3; }
        .ux-card-label.disclosure { background: #f0fdf4; color: #059669; }
        .ux-card-desc {
            font-size: 0.75rem;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 0.875rem;
        }
        .ux-pro-con {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
            margin-bottom: 0.875rem;
        }
        .ux-pro, .ux-con {
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.6875rem;
            line-height: 1.6;
        }
        .ux-pro {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        .ux-con {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }
        .ux-pro-title, .ux-con-title {
            font-weight: 700;
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.25rem;
        }
        .ux-pro-title { color: #059669; }
        .ux-con-title { color: #dc2626; }
        .ux-pro ul, .ux-con ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ux-pro li, .ux-con li {
            padding: 0.125rem 0;
            padding-left: 1rem;
            position: relative;
            font-size: 0.6875rem;
        }
        .ux-pro li { color: #065f46; }
        .ux-con li { color: #991b1b; }
        .ux-pro li::before {
            content: "\2713";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: 700;
        }
        .ux-con li::before {
            content: "\2717";
            position: absolute;
            left: 0;
            color: #ef4444;
            font-weight: 700;
        }
        .ux-best-practice {
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
            padding: 0.625rem 0.875rem;
            border-radius: 0 6px 6px 0;
            font-size: 0.6875rem;
            color: #1e40af;
            line-height: 1.5;
        }
        .ux-best-practice strong {
            display: block;
            margin-bottom: 0.125rem;
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* ===== QUICK VIEW STYLES ===== */
        /* Quick View Overlay (backdrop) */
        .quick-view-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            animation: fadeIn 0.2s ease;
        }
        .quick-view-overlay.visible {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Quick View Side Panel (Option 1) */
        .quick-view-side-panel {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 280px;
            background: #ffffff;
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        .quick-view-side-panel.visible {
            transform: translateX(0);
        }
        
        /* Quick View container positioning */
        .quick-view-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        /* In standalone mode, Quick View covers most of the chat */
        .preview-container .quick-view-container,
        #standaloneContainer .quick-view-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .preview-container .quick-view-side-panel,
        #standaloneContainer .quick-view-side-panel {
            width: 70%;
            max-width: 400px;
        }
        
        /* In mobile prototype mode, Quick View is within phone-screen */
        .phone-screen .quick-view-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
        }
        .phone-screen .quick-view-side-panel {
            width: 85%;
            max-width: 300px;
        }
        
        /* In desktop prototype mode, Quick View is within desktop-sidebar */
        .desktop-sidebar .quick-view-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
        }
        .desktop-sidebar .quick-view-side-panel {
            width: 90%;
            max-width: 320px;
        }
        .quick-view-panel-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .quick-view-panel-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: #181818;
        }
        .quick-view-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #706e6b;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        .quick-view-close:hover {
            color: #181818;
        }
        .quick-view-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .quick-view-image-large {
            width: 100%;
            height: 200px;
            object-fit: cover;
            margin-bottom: 1rem;
            background: #fafaf9;
        }
        .quick-view-product-name {
            font-size: 0.9375rem;
            font-weight: 700;
            color: #181818;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
        .quick-view-price {
            font-size: 1rem;
            font-weight: 700;
            color: #181818;
            margin-bottom: 0.75rem;
        }
        .quick-view-highlights {
            margin-bottom: 1rem;
        }
        .quick-view-highlights-title {
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #181818;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }
        .quick-view-highlights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .quick-view-highlights-list li {
            font-size: 0.75rem;
            color: #706e6b;
            padding: 0.25rem 0;
            padding-left: 1rem;
            position: relative;
        }
        .quick-view-highlights-list li::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #0176d3;
        }
        .quick-view-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: #706e6b;
        }
        .quick-view-stars {
            color: #fe9339;
        }
        .quick-view-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .btn-add-to-cart {
            background-color: #0176d3;
            color: white;
            padding: 0.625rem;
            border: none;
            border-radius: 0;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        .btn-add-to-cart:hover {
            background-color: #014486;
        }
        .btn-view-details {
            background-color: transparent;
            color: #0176d3;
            padding: 0.625rem;
            border: 1px solid #0176d3;
            border-radius: 0;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            display: block;
            letter-spacing: 0.5px;
        }
        .btn-view-details:hover {
            background-color: #0176d3;
            color: white;
        }

        /* Quick View In-Chat Card (Option 2) */
        .product-card-expanded {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
        }
        .quick-view-card-content {
            display: none;
            padding: 1rem;
            background: #ffffff;
            border-top: 2px solid #e5e5e5;
        }
        .product-card-inner.expanded .quick-view-card-content {
            display: block;
        }
        .quick-view-card-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin-bottom: 1rem;
            background: #fafaf9;
        }
        .quick-view-card-details {
            font-size: 0.8125rem;
            color: #706e6b;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        /* Quick View Modal (Option 3) */
        .quick-view-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.25);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .quick-view-modal.visible {
            display: flex;
            transform: translate(-50%, -50%) scale(1);
        }
        .quick-view-modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .quick-view-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }

        /* Quick View In-Chat Message (Option G) */
        .quick-view-in-chat-message {
            margin-top: 0.75rem;
            animation: messageSlideIn 0.3s ease-out;
        }
        .quick-view-in-chat-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            max-width: 100%;
        }
        .quick-view-in-chat-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin-bottom: 1rem;
            background: #fafaf9;
            border-radius: 8px;
        }
        .quick-view-in-chat-name {
            font-size: 1rem;
            font-weight: 600;
            color: #181818;
            margin-bottom: 0.5rem;
        }
        .quick-view-in-chat-price {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0176d3;
            margin-bottom: 1rem;
        }
        .quick-view-in-chat-description {
            font-size: 0.8125rem;
            color: #706e6b;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .quick-view-in-chat-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: #706e6b;
        }
        .quick-view-in-chat-highlights {
            margin-bottom: 1rem;
        }
        .quick-view-in-chat-highlights-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #181818;
            margin-bottom: 0.5rem;
        }
        .quick-view-in-chat-highlights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .quick-view-in-chat-highlights-list li {
            font-size: 0.75rem;
            color: #706e6b;
            padding: 0.25rem 0;
            padding-left: 1rem;
            position: relative;
        }
        .quick-view-in-chat-highlights-list li:before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #0176d3;
        }
        .quick-view-in-chat-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .quick-view-in-chat-close {
            background-color: transparent;
            color: #706e6b;
            padding: 0.5rem;
            border: 1px solid #e5e5e5;
            border-radius: 0;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }
        .quick-view-in-chat-close:hover {
            background-color: #fafaf9;
            color: #181818;
        }
        .quick-view-modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            margin-bottom: 1.5rem;
            background: #fafaf9;
        }
    </style>
</head>
<body>
    <!-- ===== LEFT SETTINGS PANEL ===== -->
    <div class="settings-panel">
        <div class="panel-title">Variation Controls</div>

        <!-- Placement Variations -->
        <div class="panel-section">
            <div class="panel-section-title">See More Placement</div>

            <label class="panel-option selected" data-placement="a">
                <input type="radio" name="placement" value="a" checked>
                <div class="panel-option-content">
                    <div class="panel-option-label">A: Header-Right Link</div>
                    <div class="panel-option-desc">Blue text link next to "Coffee Makers" heading</div>
                </div>
            </label>

            <label class="panel-option" data-placement="b">
                <input type="radio" name="placement" value="b">
                <div class="panel-option-content">
                    <div class="panel-option-label">B: Full-Width Button</div>
                    <div class="panel-option-desc">Outlined button below the carousel navigation</div>
                </div>
            </label>

            <label class="panel-option" data-placement="c">
                <input type="radio" name="placement" value="c">
                <div class="panel-option-content">
                    <div class="panel-option-label">C: See More Card</div>
                    <div class="panel-option-desc">"See More" appears as the last card in the carousel</div>
                </div>
            </label>
        </div>

        <div class="panel-divider"></div>

        <!-- Disclosure Variations -->
        <div class="panel-section">
            <div class="panel-section-title">Disclosure Pattern</div>

            <label class="panel-option selected" data-disclosure="1">
                <input type="radio" name="disclosure" value="1" checked>
                <div class="panel-option-content">
                    <div class="panel-option-label">1: Stacked Carousels</div>
                    <div class="panel-option-desc">Reveals additional carousels grouped by sub-category</div>
                </div>
            </label>

            <label class="panel-option" data-disclosure="2">
                <input type="radio" name="disclosure" value="2">
                <div class="panel-option-content">
                    <div class="panel-option-label">2: Expand Grid Below</div>
                    <div class="panel-option-desc">Additional products appear in a 2-column grid below the carousel</div>
                </div>
            </label>

            <label class="panel-option" data-disclosure="3">
                <input type="radio" name="disclosure" value="3">
                <div class="panel-option-content">
                    <div class="panel-option-label">3: Carousel Extends</div>
                    <div class="panel-option-desc">More products load into the carousel, adding extra dots</div>
                </div>
            </label>

            <label class="panel-option" data-disclosure="4">
                <input type="radio" name="disclosure" value="4">
                <div class="panel-option-content">
                    <div class="panel-option-label">4: Open Product Page</div>
                    <div class="panel-option-desc">Opens Williams Sonoma category page in a new tab</div>
                </div>
            </label>

            <label class="panel-option" data-disclosure="5">
                <input type="radio" name="disclosure" value="5">
                <div class="panel-option-content">
                    <div class="panel-option-label">5: Replace with List</div>
                    <div class="panel-option-desc">Carousel switches to a compact scrollable list view</div>
                </div>
            </label>
        </div>

        <div class="panel-divider"></div>

        <!-- CTA Pattern Variations -->
        <div class="panel-section">
            <div class="panel-section-title">CTA Pattern</div>

            <label class="panel-option selected" data-cta="d">
                <input type="radio" name="cta" value="d" checked>
                <div class="panel-option-content">
                    <div class="panel-option-label">D: Quick View from Sidebar</div>
                    <div class="panel-option-desc">Quick View opens in a side panel overlay</div>
                </div>
            </label>

            <label class="panel-option" data-cta="e">
                <input type="radio" name="cta" value="e">
                <div class="panel-option-content">
                    <div class="panel-option-label">E: Quick View In-Chat Card</div>
                    <div class="panel-option-desc">Quick View opens a detailed card as a new message in chat</div>
                </div>
            </label>
        </div>

        <!-- Spacer to push prototype toggle to bottom -->
        <div style="flex:1;"></div>

        <!-- Live Prototype Mode Toggle (bottom of panel) -->
        <div class="panel-proto-footer">
            <div class="panel-divider"></div>
            <label class="panel-proto-toggle" for="prototypeModeToggle">
                <span class="panel-proto-toggle-label">Live Prototype Mode</span>
                <span class="toggle-switch">
                    <input type="checkbox" id="prototypeModeToggle">
                    <span class="toggle-slider"></span>
                </span>
            </label>

            <!-- Device Preview Toggle (visible only in prototype mode) -->
            <div class="panel-device-options" id="deviceToggleSection" style="display: none;">
                <label class="panel-option selected" data-device="mobile">
                    <input type="radio" name="device" value="mobile" checked>
                    <div class="panel-option-content">
                        <div class="panel-option-label">Mobile</div>
                    </div>
                </label>
                <label class="panel-option" data-device="desktop">
                    <input type="radio" name="device" value="desktop">
                    <div class="panel-option-content">
                        <div class="panel-option-label">Desktop</div>
                    </div>
                </label>
            </div>
        </div>
    </div>

    <!-- ===== RIGHT PREVIEW AREA ===== -->
    <div class="preview-area" id="previewArea">
        <!-- Mobile Phone Frame (Prototype Mode) -->
        <div class="phone-frame" id="mobileFrame" style="display: none;">
            <div class="phone-bezel">
                <div class="phone-dynamic-island"></div>
                <div class="phone-screen" id="mobileScreen">
                    <div class="chat-header-bar" id="mobileHeaderBar">
                        <span class="chat-header-sparkle">âœ¦</span>
                        <span class="chat-header-brand-name">AI Sous Chef</span>
                        <div class="chat-header-actions">
                            <button class="chat-header-btn chat-menu-btn" title="More options">â‹®</button>
                        </div>
                        <div class="chat-header-menu">
                            <div class="chat-header-menu-item" onclick="handleEndChat()">End Chat</div>
                        </div>
                    </div>
                    <div class="phone-screen-body" id="mobileScreenBody">
                        <!-- chatContainer is moved here in mobile mode -->
                    </div>
                    <div class="mobile-input-bar">
                        <input type="text" class="mobile-input-field" placeholder="Type your message..." disabled>
                    </div>
                    <div class="chat-minimized-fab" id="mobileMinimizedFab" onclick="restoreChat('mobile')">
                        <img src="https://wsgc.my.site.com/ESWSousChefAgentOlive1760167198695vforce/resource/AgentOliveIcon" alt="Open chat">
                    </div>
                </div>
                <div class="phone-home-indicator-wrap">
                    <div class="phone-home-indicator"></div>
                </div>
            </div>
        </div>

        <!-- Desktop Browser Frame (Prototype Mode) -->
        <div class="desktop-frame" id="desktopFrame" style="display: none;">
            <div class="browser-chrome">
                <div class="browser-dots">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                </div>
                <div class="browser-url-bar">
                    <span class="lock-icon">ðŸ”’</span>
                    <span>www.williams-sonoma.com</span>
                </div>
            </div>
            <div class="browser-viewport">
                <!-- WS Site Mockup -->
                <div class="ws-mockup">
                    <div class="ws-brands-bar">
                        <span class="ws-brand-active">Williams Sonoma</span>
                        <span>Williams Sonoma Home</span>
                        <span>Pottery Barn</span>
                        <span>PB Kids</span>
                        <span>PB Teen</span>
                        <span>West Elm</span>
                        <span>Rejuvenation</span>
                        <span>Mark &amp; Graham</span>
                        <span>GreenRow</span>
                    </div>
                    <div class="ws-join-bar">Williams Sonoma Reserve â€“ Enjoy free shipping on eligible purchases* <a href="#">JOIN NOW â†’</a></div>
                    <div class="ws-main-header">
                        <div class="ws-logo-text">WILLIAMS SONOMA</div>
                    </div>
                    <div class="ws-nav-bar">
                        <span>AI Sous Chef</span>
                        <span>Lunar New Year</span>
                        <span>Valentine's Day</span>
                        <span>Easter</span>
                        <span>Recipes &amp; Menus</span>
                        <span>Entertaining</span>
                    </div>
                    <div class="ws-nav-bar" style="border-top: none; padding-top: 0;">
                        <span>New</span>
                        <span>Cookware</span>
                        <span>Cook's Tools</span>
                        <span>Cutlery</span>
                        <span class="ws-nav-active">Electrics</span>
                        <span>Bakeware</span>
                        <span>Food</span>
                        <span>Tabletop &amp; Bar</span>
                        <span>Home Essentials</span>
                    </div>
                    <div class="ws-hero">
                        <div class="ws-hero-overlay">
                            <div class="ws-hero-title">THE ART OF COFFEE</div>
                            <div class="ws-hero-subtitle">Discover our curated collection of premium coffee makers</div>
                            <button class="ws-hero-cta">SHOP COFFEE</button>
                        </div>
                    </div>
                    <div class="ws-section">
                        <div class="ws-section-title">SHOP BY CATEGORY</div>
                        <div class="ws-category-grid">
                            <div class="ws-category-card"><span>Drip Coffee</span></div>
                            <div class="ws-category-card"><span>Espresso</span></div>
                            <div class="ws-category-card"><span>Grinders</span></div>
                            <div class="ws-category-card"><span>Pour Over</span></div>
                        </div>
                    </div>
                    <div class="ws-section">
                        <div class="ws-section-title">TRENDING NOW</div>
                    </div>
                    <div class="ws-product-row">
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                    </div>
                    <div class="ws-section">
                        <div class="ws-section-title">BEST SELLERS</div>
                    </div>
                    <div class="ws-product-row">
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                        <div class="ws-product-mock"><div class="ws-product-mock-img"></div><div class="ws-product-mock-name"></div><div class="ws-product-mock-price"></div></div>
                    </div>
                </div>

                <!-- Chat Sidebar -->
                <div class="desktop-sidebar" id="desktopSidebar">
                    <div class="chat-header-bar" id="desktopHeaderBar">
                        <span class="chat-header-sparkle">âœ¦</span>
                        <span class="chat-header-brand-name">AI Sous Chef</span>
                        <div class="chat-header-actions">
                            <button class="chat-header-btn chat-menu-btn" title="More options">â‹®</button>
                            <button class="chat-header-btn chat-minimize-btn" title="Minimize">âŒ„</button>
                        </div>
                        <div class="chat-header-menu">
                            <div class="chat-header-menu-item" onclick="handleEndChat()">End Chat</div>
                        </div>
                    </div>
                    <!-- chatContainer is moved here in desktop mode -->
                    <div class="sidebar-input-bar" id="sidebarInputBar">
                        <input type="text" class="sidebar-input-field" placeholder="Type your message..." disabled>
                    </div>
                </div>
                <div class="chat-minimized-fab" id="desktopMinimizedFab" onclick="restoreChat('desktop')" style="position:absolute;bottom:20px;right:20px;">
                    <img src="https://wsgc.my.site.com/ESWSousChefAgentOlive1760167198695vforce/resource/AgentOliveIcon" alt="Open chat">
                </div>
            </div>
        </div>

        <!-- Chat Container (moved between frames via JS) -->
        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-message user">
                <div class="message-bubble">
                    <div class="message-text">Can you recommend a good coffee maker?</div>
                </div>
                <div class="message-time">Just now</div>
            </div>
            <div class="chat-message agent">
                <div class="chat-avatar"><img src="https://wsgc.my.site.com/ESWSousChefAgentOlive1760167198695vforce/resource/AgentOliveIcon" alt="Agent Olive"></div>
                <div class="message-content">
                    <div class="preview-container" id="chatPreviewContainer">
                        <!-- Carousel will be cloned here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Standalone Mode (current) -->
        <div class="preview-container" id="standaloneContainer">
            <!-- Header Section -->
            <div class="header">
                <div class="header-row">
                    <h2>Coffee Makers</h2>
                    <!-- Placement A: Header-Right Link -->
                    <a href="#" class="see-more-link see-more-a is-hidden" onclick="handleSeeMore(event)">See More</a>
                </div>
                <p>Curated just for you &bull; 5 items</p>
            </div>

            <!-- Carousel Section (can be hidden by Disclosure 4) -->
            <div class="carousel-section" id="carouselSection">
                <!-- Carousel Container -->
                <div class="carousel-wrapper">
                    <div class="carousel-track" id="carouselTrack"></div>
                </div>

                <!-- Carousel Navigation -->
                <div class="carousel-navigation">
                    <button class="carousel-nav" id="prevBtn" onclick="handlePrevious()" disabled>&lsaquo;</button>
                    <div class="pagination-container" id="paginationDots"></div>
                    <button class="carousel-nav" id="nextBtn" onclick="handleNext()">&rsaquo;</button>
                </div>
            </div>

            <!-- Placement B: Full-Width Button (below navigation) -->
            <a href="#" class="see-more-button-full see-more-b is-hidden" onclick="handleSeeMore(event)">See More Items</a>

            <!-- Disclosure 1: Expanded Grid -->
            <div class="expanded-grid" id="expandedGrid"></div>

            <!-- Disclosure 4: Scrollable List -->
            <div class="scrollable-list" id="scrollableList"></div>

            <!-- Disclosure 5: Stacked Carousels -->
            <div class="stacked-carousels" id="stackedCarousels"></div>

            <!-- Conversation Nudge Chips (shown after See More) -->
            <div class="nudge-chips-container" id="nudgeChips">
                <div class="nudge-chips-label">Refine your picks</div>
                <div class="nudge-chips-row" id="nudgeChipsRow"></div>
            </div>

            <!-- Conversation Thread (appended turns from nudge chips) -->
            <div class="conversation-thread" id="conversationThread"></div>
        </div>

    </div>

    <!-- ===== RIGHT RAIL (UX Commentary) ===== -->
    <div class="ux-rail" id="uxRail">
        <button class="ux-rail-toggle" id="uxRailToggle" title="Collapse UX commentary">&#x276F;</button>
        <div class="ux-rail-header">
            <div class="ux-rail-title">UX Commentary</div>
        </div>
        <div class="ux-rail-body">
            <div class="ux-explanations" id="uxExplanations"></div>
        </div>
    </div>

    <!-- ===== QUICK VIEW COMPONENTS ===== -->
    <!-- Quick View Side Panel is created dynamically and appended to the appropriate container -->
    
    <!-- Quick View Modal (Option 3) -->
    <div class="quick-view-modal" id="quickViewModal">
        <div class="quick-view-modal-header">
            <div class="quick-view-panel-title" id="quickViewModalTitle">Quick View</div>
            <button class="quick-view-close" onclick="closeQuickView()">&times;</button>
        </div>
        <div class="quick-view-modal-body" id="quickViewModalBody"></div>
    </div>

    <script>
        // ===== PRODUCT DATA =====
        const mockProducts = [
            {
                id: '1',
                name: 'Breville The Luxe Brewer with Thermal Carafe',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202543/0340/img1z.jpg',
                price: 349.95,
                badge: 'olivePick',
                productUrl: 'https://www.williams-sonoma.com/products/breville-the-luxe-brewer-with-thermal-carafe/',
                description: 'Premium coffee maker with thermal carafe that keeps coffee hot for hours. Features precision temperature control and pre-infusion brewing for optimal flavor extraction.',
                rating: 4.8,
                reviewCount: 324,
                highlights: [
                    'Thermal carafe keeps coffee hot up to 4 hours',
                    'Precision temperature control (195-205Â°F)',
                    'Pre-infusion cycle for even extraction',
                    '12-cup capacity'
                ]
            },
            {
                id: '2',
                name: 'Fellow Aiden Coffee Brewer',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202536/0183/img39z.jpg',
                price: 299.95,
                badge: 'bestSeller',
                productUrl: 'https://www.williams-sonoma.com/products/fellow-aiden-coffee-brewer/',
                description: 'Sleek, modern coffee maker with precise water temperature and flow rate control. Designed for coffee enthusiasts who want restaurant-quality coffee at home.',
                rating: 4.6,
                reviewCount: 187,
                highlights: [
                    'Precise water temperature control',
                    'Adjustable flow rate',
                    'Sleek, compact design',
                    '8-cup capacity'
                ]
            },
            {
                id: '3',
                name: 'Cafe Specialty Drip Coffee Maker with Glass Carafe',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202440/0021/cafe-specialty-drip-coffee-maker-with-glass-carafe-o.jpg',
                price: 199.95,
                badge: 'topRated',
                productUrl: 'https://www.williams-sonoma.com/products/cafe-specialty-drip-coffee-maker-with-glass/',
                description: 'Classic drip coffee maker with programmable timer and auto-shutoff. Features a glass carafe with warming plate and 12-cup capacity.',
                rating: 4.5,
                reviewCount: 256,
                highlights: [
                    'Programmable 24-hour timer',
                    'Auto-shutoff feature',
                    'Glass carafe with warming plate',
                    '12-cup capacity'
                ]
            },
            {
                id: '4',
                name: 'Moccamaster by Technivorm KBGV Select Coffee Maker, 10-cup',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202414/0036/moccamaster-by-technivorm-kbgv-select-10-cup-coffee-maker-o.jpg',
                price: 369.95,
                badge: 'olivePick',
                productUrl: 'https://www.williams-sonoma.com/products/technivorm-moccamaster-kgb-select/',
                description: 'Dutch-engineered coffee maker with copper heating element for optimal brewing temperature. SCAA certified for perfect coffee extraction.',
                rating: 4.9,
                reviewCount: 412,
                highlights: [
                    'SCAA certified brewing',
                    'Copper heating element',
                    'Brews at optimal 196-205Â°F',
                    '10-cup capacity'
                ]
            },
            {
                id: '5',
                name: 'OXO Brew 12-Cup Coffee Maker',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202451/0005/img97o.jpg',
                price: 199.95,
                badge: 'bestSeller',
                productUrl: 'https://www.williams-sonoma.com/products/oxo-brew-12-cup-coffee-maker-with-podless-single-serve-function/',
                description: 'Versatile coffee maker with both carafe and single-serve options. Features precision brewing technology and reusable filter basket.',
                rating: 4.4,
                reviewCount: 298,
                highlights: [
                    'Dual brewing modes (carafe + single-serve)',
                    'Precision brewing technology',
                    'Reusable filter basket',
                    '12-cup capacity'
                ]
            }
        ];

        // Extra products for disclosure patterns
        const extraProducts = [
            {
                id: '6',
                name: 'Cuisinart Touchscreen 14-Cup Coffee Maker',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202514/0010/cuisinart-touchscreen-14-cup-coffee-maker-o.jpg',
                price: 129.95,
                badge: 'topRated',
                productUrl: 'https://www.williams-sonoma.com/products/cuisinart-touchscreen-12-cup-coffee-maker/'
            },
            {
                id: '7',
                name: 'De\'Longhi TrueBrew Automatic Coffee Maker',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202509/0002/delonghi-truebrew-automatic-coffee-maker-with-bean-extract-1-o.jpg',
                price: 329.95,
                badge: 'bestSeller',
                productUrl: 'https://www.williams-sonoma.com/products/delonghi-truebrew-auto-coffee-with-bean-extract-carafe/'
            },
            {
                id: '8',
                name: 'Cuisinart Coffee-On-Demand 12-Cup Programmable',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202406/0092/img7o.jpg',
                price: 99.95,
                badge: null,
                productUrl: 'https://www.williams-sonoma.com/products/cuisinart-coffee-on-demand-coffee-maker/'
            },
            {
                id: '9',
                name: 'Open Kitchen Programmable Coffee Maker, 12-cup',
                imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202451/0005/img97o.jpg',
                price: 59.95,
                badge: 'topRated',
                productUrl: 'https://www.williams-sonoma.com/products/open-kitchen-by-ws-programmable-coffee-maker/'
            }
        ];

        // Sub-category data for Disclosure 5
        const subCategories = [
            {
                title: 'Espresso Machines',
                products: [
                    { id: 'e1', name: 'Breville Barista Express', imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202543/0340/img1z.jpg', price: 749.95, badge: 'bestSeller', productUrl: '#' },
                    { id: 'e2', name: 'De\'Longhi La Specialista', imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202509/0002/delonghi-truebrew-automatic-coffee-maker-with-bean-extract-1-o.jpg', price: 599.95, badge: 'topRated', productUrl: '#' },
                    { id: 'e3', name: 'Nespresso Vertuo Next', imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202414/0036/moccamaster-by-technivorm-kbgv-select-10-cup-coffee-maker-o.jpg', price: 199.95, badge: 'olivePick', productUrl: '#' },
                    { id: 'e4', name: 'JURA E8 Automatic Coffee Center', imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202543/0340/img1z.jpg', price: 1499.95, badge: null, productUrl: '#' },
                    { id: 'e5', name: 'SMEG Espresso Machine', imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202536/0183/img39z.jpg', price: 449.95, badge: 'bestSeller', productUrl: '#' }
                ]
            },
            {
                title: 'Coffee Grinders',
                products: [
                    { id: 'g1', name: 'Baratza Encore ESP Grinder', imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202536/0183/img39z.jpg', price: 199.95, badge: 'topRated', productUrl: '#' },
                    { id: 'g2', name: 'Fellow Ode Brew Grinder Gen 2', imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202440/0021/cafe-specialty-drip-coffee-maker-with-glass-carafe-o.jpg', price: 345.00, badge: 'olivePick', productUrl: '#' },
                    { id: 'g3', name: 'Comandante C40 Hand Grinder', imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202451/0005/img97o.jpg', price: 275.00, badge: 'bestSeller', productUrl: '#' },
                    { id: 'g4', name: 'Breville Smart Grinder Pro', imageUrl: 'https://assets.wsimgs.com/wsimgs/rk/images/dp/wcm/202543/0340/img1z.jpg', price: 199.95, badge: 'topRated', productUrl: '#' },
                    { id: 'g5', name: '1Zpresso J-Max Manual Grinder', imageUrl: 'https://assets.wsimgs.com/wsimgs/ab/images/dp/wcm/202440/0021/cafe-specialty-drip-coffee-maker-with-glass-carafe-o.jpg', price: 199.00, badge: 'olivePick', productUrl: '#' }
                ]
            }
        ];

        // ===== STATE =====
        let currentIndex = 0;
        let itemsPerView = 2;
        let TOTAL_DOTS = 5;
        let activePlacement = 'a';
        let activeDisclosure = '1';
        let activeCtaPattern = 'd';
        let isExpanded = false;
        let allProducts = [...mockProducts]; // used for disclosure 2
        let activeQuickView = null; // Currently open Quick View product
        let quickViewType = null; // 'sidePanel', 'card', or 'modal'

        // ===== CAROUSEL RENDERING =====
        function formatPrice(price) {
            return `$${price.toFixed(2)}`;
        }

        function getVisibleItems() {
            const items = [];
            // Only show See More card for placement C when NOT yet expanded
            const showSeeMoreCard = activePlacement === 'c' && !isExpanded;
            const totalItems = showSeeMoreCard ? allProducts.length + 1 : allProducts.length;
            
            for (let i = 0; i < itemsPerView; i++) {
                const idx = (currentIndex + i) % totalItems;
                
                if (showSeeMoreCard && idx === allProducts.length) {
                    items.push({ type: 'seeMore' });
                } else {
                    items.push({ type: 'product', product: allProducts[idx] });
                }
            }
            return items;
        }

        function renderBadge(badge) {
            if (!badge) return '';
            
            const badgeConfig = {
                olivePick: { text: 'OLIVE PICK', class: 'badge-olive-pick' },
                bestSeller: { text: 'BEST SELLER', class: 'badge-best-seller' },
                topRated: { text: 'TOP RATED', class: 'badge-top-rated' }
            };
            
            const config = badgeConfig[badge];
            if (!config) return '';
            
            return `<div class="product-badge ${config.class}"><span class="badge-text">${config.text}</span></div>`;
        }

        function renderProductCard(product) {
            // Support both old isOlivePick and new badge property for backward compatibility
            const badge = product.badge || (product.isOlivePick ? 'olivePick' : null);
            
            // Always show both Quick View and Shop Now buttons
            const quickViewBtn = `<button class="btn btn-quick-view" onclick="handleQuickView('${product.id}')">QUICK VIEW</button>`;
            const shopNowBtn = `<a href="${product.productUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-shop-now">SHOP NOW</a>`;
            
            return `
                <div class="product-card" data-product-id="${product.id}">
                    <div class="product-card-inner">
                        ${renderBadge(badge)}
                        <div class="product-image-container">
                            <img src="${product.imageUrl}" alt="${product.name}" class="product-image"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/fafaf9/706e6b?text=Coffee+Maker';">
                        </div>
                        <div class="product-details">
                            <h3 class="product-name">${product.name}</h3>
                            <div class="price-text">${formatPrice(product.price)}</div>
                            <div class="action-buttons">
                                ${quickViewBtn}
                                ${shopNowBtn}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderSeeMoreCard() {
            return `
                <div class="see-more-card see-more-c">
                    <div class="see-more-card-inner" onclick="handleSeeMore(event)">
                        <div class="see-more-card-icon">&rsaquo;</div>
                        <div class="see-more-card-text">See More</div>
                    </div>
                </div>`;
        }

        function renderCarousel() {
            // Render in standalone container (source of truth)
            const standalone = document.getElementById('standaloneContainer');
            const track = standalone ? standalone.querySelector('#carouselTrack') : document.getElementById('carouselTrack');
            if (track) {
                const items = getVisibleItems();
                track.innerHTML = items.map(item => 
                    item.type === 'seeMore' ? renderSeeMoreCard() : renderProductCard(item.product)
                ).join('');
            }
            
            updateNavigation();
            renderPagination();
            
            // Also render in chat container if it exists and is visible
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer && chatContainer.style.display !== 'none') {
                renderCarouselInContainer(document.getElementById('chatPreviewContainer'));
            }
        }

        function updateNavigation() {
            const standalone = document.getElementById('standaloneContainer');
            const prevBtn = standalone ? standalone.querySelector('#prevBtn') : document.getElementById('prevBtn');
            const nextBtn = standalone ? standalone.querySelector('#nextBtn') : document.getElementById('nextBtn');
            if (prevBtn) prevBtn.disabled = currentIndex === 0;
            if (nextBtn) nextBtn.disabled = currentIndex >= TOTAL_DOTS - 1;
        }

        function renderPagination() {
            const standalone = document.getElementById('standaloneContainer');
            const dots = standalone ? standalone.querySelector('#paginationDots') : document.getElementById('paginationDots');
            if (dots) {
                dots.innerHTML = Array.from({ length: TOTAL_DOTS }, (_, i) =>
                    `<button class="pagination-dot ${i === currentIndex ? 'active' : ''}" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}"></button>`
                ).join('');
            }
        }

        function handlePrevious() { if (currentIndex > 0) { currentIndex--; renderCarousel(); } }
        function handleNext() { if (currentIndex < TOTAL_DOTS - 1) { currentIndex++; renderCarousel(); } }
        function goToSlide(i) { if (i >= 0 && i < TOTAL_DOTS) { currentIndex = i; renderCarousel(); } }

        // ===== HELPERS: always target standalone container (source of truth) =====
        function getStandalone() {
            return document.getElementById('standaloneContainer');
        }
        function $id(id) {
            // Always resolve IDs from the standalone container to avoid duplicate-ID issues
            return getStandalone().querySelector('#' + id);
        }

        // ===== CONVERSATION NUDGE CHIPS & THREAD =====
        // Master chip definitions
        const allChipDefs = [
            { id: 'price_200',    label: 'Under $200',        icon: 'ðŸ’°', type: 'price',    value: 200 },
            { id: 'price_400',    label: '$200\u2013$400',     icon: 'ðŸ’°', type: 'price',    value: 400 },
            { id: 'price_999',    label: '$400+',             icon: 'ðŸ’°', type: 'price',    value: 999 },
            { id: 'badge_top',    label: 'Top Rated',         icon: 'â­', type: 'badge',    value: 'topRated' },
            { id: 'badge_best',   label: 'Best Sellers',      icon: 'ðŸ”¥', type: 'badge',    value: 'bestSeller' },
            { id: 'badge_olive',  label: 'Olive Picks',       icon: 'ðŸ«’', type: 'badge',    value: 'olivePick' },
            { id: 'cat_espresso', label: 'Espresso Machines',  icon: 'â˜•', type: 'category', value: 0, accent: true },
            { id: 'cat_grinder',  label: 'Coffee Grinders',    icon: 'âš™ï¸', type: 'category', value: 1, accent: true },
            { id: 'link_browse',  label: 'Browse All on WS',   icon: 'â†’',  type: 'link',    accent: true },
            { id: 'help_decide',  label: 'Help Me Decide',     icon: 'ðŸ’¬', type: 'help',    accent: true },
        ];

        // Contextual commentary per chip type/value
        const commentary = {
            price_200:    'Here are some great coffee makers under $200:',
            price_400:    'In the $200\u2013$400 range, these are popular picks:',
            price_999:    'For premium coffee makers over $400:',
            badge_top:    'Here are our top-rated coffee makers:',
            badge_best:   'These are the current best sellers:',
            badge_olive:  'Our experts recommend these Olive Picks:',
            cat_espresso: 'Take a look at our espresso machines:',
            cat_grinder:  'Here are some coffee grinders to pair with your maker:',
            help_decide:  'Based on ratings and popularity, here are my top 3 recommendations:',
        };

        // Which chip IDs to offer NEXT after a given chip type
        function getNextChipIds(usedChipId) {
            const chip = allChipDefs.find(c => c.id === usedChipId);
            if (!chip) return allChipDefs.filter(c => c.type !== 'link').map(c => c.id);
            const usedType = chip.type;

            if (usedType === 'price') {
                return ['badge_top', 'badge_best', 'badge_olive', 'cat_espresso', 'cat_grinder', 'help_decide'];
            } else if (usedType === 'badge') {
                return ['price_200', 'price_400', 'price_999', 'cat_espresso', 'cat_grinder', 'help_decide'];
            } else if (usedType === 'category') {
                return ['price_200', 'price_400', 'price_999', 'badge_top', 'badge_best', 'badge_olive', 'help_decide'];
            } else if (usedType === 'help') {
                return ['price_200', 'price_400', 'price_999', 'link_browse'];
            }
            return allChipDefs.filter(c => c.type !== 'link').map(c => c.id);
        }

        // Resolve products for a chip
        function getProductsForChip(chipDef) {
            const allItems = [...mockProducts, ...extraProducts];
            if (chipDef.type === 'price') {
                let filtered;
                if (chipDef.value === 200) filtered = allItems.filter(p => p.price < 200);
                else if (chipDef.value === 400) filtered = allItems.filter(p => p.price >= 200 && p.price <= 400);
                else filtered = allItems.filter(p => p.price > 400);
                return filtered.length ? filtered : allItems;
            } else if (chipDef.type === 'badge') {
                const filtered = allItems.filter(p => p.badge === chipDef.value);
                return filtered.length ? filtered : allItems;
            } else if (chipDef.type === 'category') {
                const cat = subCategories[chipDef.value];
                return cat ? cat.products : [];
            } else if (chipDef.type === 'help') {
                const priority = { olivePick: 1, bestSeller: 2, topRated: 3 };
                return [...allItems].sort((a, b) => (priority[a.badge] || 99) - (priority[b.badge] || 99)).slice(0, 3);
            }
            return [];
        }

        // Turn counter and state for unique IDs / carousels within turns
        let turnCounter = 0;
        const turnCarouselIndices = {};
        const turnData = {};

        // Render a set of chip buttons as HTML string
        function renderChipButtons(chipIds, turnId) {
            return chipIds.map(cid => {
                const def = allChipDefs.find(c => c.id === cid);
                if (!def) return '';
                return `<button class="nudge-chip${def.accent ? ' accent' : ''}" data-chip-id="${def.id}" onclick="handleNudgeChip('${def.id}', ${turnId})" title="${def.label}"><span class="nudge-chip-icon">${def.icon}</span>${def.label}</button>`;
            }).join('');
        }

        // Render the initial nudge chips row (after See More)
        function renderNudgeChips() {
            const row = $id('nudgeChipsRow');
            if (!row) return;
            const initialIds = allChipDefs.filter(c => c.type !== 'link').map(c => c.id);
            row.innerHTML = renderChipButtons(initialIds, -1);
        }

        function showNudgeChips() {
            const container = $id('nudgeChips');
            if (container) {
                turnCounter = 0;
                renderNudgeChips();
                container.classList.add('visible');
            }
        }

        function hideNudgeChips() {
            const container = $id('nudgeChips');
            if (container) container.classList.remove('visible');
        }

        // ===== CORE: Append a conversation turn =====
        function appendConversationTurn(chipId, sourceRowTurnId) {
            const chipDef = allChipDefs.find(c => c.id === chipId);
            if (!chipDef) return;

            // 1. Disable all chips in the source row and highlight the clicked one
            disableChipsInRow(sourceRowTurnId, chipId);

            // 2. Resolve content
            const text = commentary[chipId] || 'Here are some picks:';
            const products = getProductsForChip(chipDef);
            const nextChipIds = getNextChipIds(chipId);

            // 3. Build turn HTML -- product layout matches selected disclosure
            const currentTurnId = turnCounter++;
            turnData[currentTurnId] = { products: products };
            const productHtml = renderTurnProducts(products, currentTurnId);

            const turnHtml = `
                <div class="conversation-turn" data-turn-id="${currentTurnId}">
                    <div class="turn-commentary">${text}</div>
                    ${productHtml}
                    ${nextChipIds.length ? `
                    <div class="turn-nudge-row" data-turn-id="${currentTurnId}">
                        <div class="turn-nudge-label">Keep exploring</div>
                        ${renderChipButtons(nextChipIds, currentTurnId)}
                    </div>` : ''}
                </div>`;

            // 4. Append to thread
            const thread = $id('conversationThread');
            if (thread) {
                thread.insertAdjacentHTML('beforeend', turnHtml);
            }

            // 5. Sync chat and auto-scroll
            syncChatContainer();
            autoScrollToLatestTurn();
        }

        // Render products in the style matching the active disclosure pattern
        function renderTurnProducts(products, turnId) {
            if (activeDisclosure === '1' || activeDisclosure === '3') {
                return renderTurnCarousel(products, turnId);
            } else if (activeDisclosure === '5') {
                return renderTurnList(products);
            } else {
                // Disclosure 2, 4: 2-column grid (default)
                return `<div class="turn-grid">${products.map(renderProductCard).join('')}</div>`;
            }
        }

        // Mini-carousel for turn (disclosures 1 & 3)
        function renderTurnCarousel(products, turnId) {
            const carouselId = `turnCarousel_${turnId}`;
            turnCarouselIndices[carouselId] = 0;
            const currentIdx = 0;
            const totalDots = products.length;

            const visibleProducts = [];
            for (let i = 0; i < 2 && (currentIdx + i) < products.length; i++) {
                visibleProducts.push(products[currentIdx + i]);
            }

            const dots = Array.from({ length: totalDots }, (_, i) =>
                `<button class="sub-dot ${i === currentIdx ? 'active' : ''}" onclick="goToTurnCarouselSlide(${turnId}, ${i})" aria-label="Go to slide ${i + 1}"></button>`
            ).join('');

            const canGoNext = totalDots > 1;

            return `
                <div class="turn-carousel" data-turn-carousel="${turnId}">
                    <div class="sub-carousel-wrapper">
                        <button class="sub-carousel-nav-btn" onclick="turnCarouselPrev(${turnId})" disabled>&lsaquo;</button>
                        <div class="sub-carousel-track">
                            ${visibleProducts.map(renderProductCard).join('')}
                        </div>
                        <button class="sub-carousel-nav-btn" onclick="turnCarouselNext(${turnId})" ${canGoNext ? '' : 'disabled'}>&rsaquo;</button>
                    </div>
                    <div class="sub-carousel-nav">${dots}</div>
                </div>`;
        }

        // Compact list for turn (disclosure 4)
        function renderTurnList(products) {
            return `<div class="turn-list">${products.map(p => `
                <a href="${p.productUrl}" target="_blank" rel="noopener noreferrer" class="list-item">
                    <img src="${p.imageUrl}" class="list-item-img" alt="${p.name}"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/52x52/fafaf9/706e6b?text=...';">
                    <div class="list-item-info">
                        <div class="list-item-name">${p.name}</div>
                        <div class="list-item-price">${formatPrice(p.price)}</div>
                    </div>
                    <span class="list-item-arrow">&rsaquo;</span>
                </a>`).join('')}</div>`;
        }

        // Turn-carousel navigation
        function turnCarouselPrev(turnId) {
            const carouselId = `turnCarousel_${turnId}`;
            if ((turnCarouselIndices[carouselId] || 0) > 0) {
                turnCarouselIndices[carouselId]--;
                updateTurnCarousel(turnId);
            }
        }
        function turnCarouselNext(turnId) {
            const carouselId = `turnCarousel_${turnId}`;
            const data = turnData[turnId];
            if (!data) return;
            const currentIdx = turnCarouselIndices[carouselId] || 0;
            if (currentIdx < data.products.length - 1) {
                turnCarouselIndices[carouselId] = currentIdx + 1;
                updateTurnCarousel(turnId);
            }
        }
        function goToTurnCarouselSlide(turnId, slideIndex) {
            turnCarouselIndices[`turnCarousel_${turnId}`] = slideIndex;
            updateTurnCarousel(turnId);
        }
        function updateTurnCarousel(turnId) {
            const carouselId = `turnCarousel_${turnId}`;
            const data = turnData[turnId];
            if (!data) return;
            const currentIdx = turnCarouselIndices[carouselId] || 0;
            const products = data.products;
            const totalDots = products.length;

            const turnEl = getStandalone().querySelector(`.turn-carousel[data-turn-carousel="${turnId}"]`);
            if (!turnEl) return;

            // Update visible products
            const visibleProducts = [];
            for (let i = 0; i < 2 && (currentIdx + i) < products.length; i++) {
                visibleProducts.push(products[currentIdx + i]);
            }
            const track = turnEl.querySelector('.sub-carousel-track');
            if (track) track.innerHTML = visibleProducts.map(renderProductCard).join('');

            // Update nav buttons
            const buttons = turnEl.querySelectorAll('.sub-carousel-nav-btn');
            if (buttons[0]) buttons[0].disabled = currentIdx === 0;
            if (buttons[1]) buttons[1].disabled = currentIdx >= totalDots - 1;

            // Update dots
            turnEl.querySelectorAll('.sub-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === currentIdx);
            });

            syncChatContainer();
        }

        // Expose globally
        window.turnCarouselPrev = turnCarouselPrev;
        window.turnCarouselNext = turnCarouselNext;
        window.goToTurnCarouselSlide = goToTurnCarouselSlide;

        function disableChipsInRow(turnId, selectedChipId) {
            // turnId === -1 means the initial nudge chips row (#nudgeChipsRow)
            let row;
            if (turnId === -1) {
                row = $id('nudgeChipsRow');
            } else {
                row = getStandalone().querySelector(`.turn-nudge-row[data-turn-id="${turnId}"]`);
            }
            if (!row) return;
            row.querySelectorAll('.nudge-chip').forEach(btn => {
                const cid = btn.getAttribute('data-chip-id');
                if (cid === selectedChipId) {
                    btn.classList.add('selected');
                } else {
                    btn.disabled = true;
                }
            });
        }

        function autoScrollToLatestTurn() {
            // Scroll the correct scrollable container so the new turn is visible
            setTimeout(() => {
                let target;
                const mobileFrame = document.getElementById('mobileFrame');
                const desktopFrame = document.getElementById('desktopFrame');

                if (mobileFrame && mobileFrame.style.display !== 'none') {
                    target = document.getElementById('mobileScreenBody');
                } else if (desktopFrame && desktopFrame.style.display !== 'none') {
                    target = document.getElementById('chatContainer');
                } else {
                    target = document.getElementById('previewArea');
                }
                if (target) {
                    target.scrollTo({ top: target.scrollHeight, behavior: 'smooth' });
                }
            }, 50);
        }

        // Unified handler for all nudge chip clicks (initial row and turn rows)
        function handleNudgeChip(chipId, turnId) {
            const chipDef = allChipDefs.find(c => c.id === chipId);
            if (!chipDef) return;

            // Special case: external link doesn't append a turn
            if (chipDef.type === 'link') {
                window.open('https://www.williams-sonoma.com/shop/electrics/coffee-makers/', '_blank');
                return;
            }

            appendConversationTurn(chipId, turnId);
        }

        // Make nudge handler global
        window.handleNudgeChip = handleNudgeChip;

        // ===== SEE MORE HANDLER =====
        function handleSeeMore(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            if (isExpanded) return; // Already expanded, no-op

            if (activeDisclosure === '1') {
                showStackedCarousels();
            } else if (activeDisclosure === '2') {
                expandGrid();
            } else if (activeDisclosure === '3') {
                extendCarousel();
            } else if (activeDisclosure === '4') {
                window.open('https://www.williams-sonoma.com/shop/electrics/coffee-makers/', '_blank');
                return; // Don't hide See More for external link
            } else if (activeDisclosure === '5') {
                showListView();
            }

            // Hide See More and show nudge chips
            isExpanded = true;
            hideSeeMore();
            showNudgeChips();
            syncChatContainer();
        }

        function hideSeeMore() {
            // Hide all See More elements
            getStandalone().querySelectorAll('.see-more-a, .see-more-b').forEach(el => {
                el.classList.add('is-hidden');
            });
            // For placement C, re-render carousel without the See More card
            if (activePlacement === 'c') {
                TOTAL_DOTS = allProducts.length;
                currentIndex = Math.min(currentIndex, TOTAL_DOTS - 1);
                renderCarousel();
            }
        }

        // Disclosure 1: Expand grid (one-way, no toggle)
        function expandGrid() {
            const grid = $id('expandedGrid');
            grid.innerHTML = `
                <div class="expanded-grid-title">More Coffee Makers</div>
                <div class="expanded-grid-track">
                    ${extraProducts.map(renderProductCard).join('')}
                </div>
            `;
            grid.classList.add('visible');
        }

        function syncChatContainer() {
            const chatContainer = document.getElementById('chatContainer');
            const standaloneContainer = getStandalone();
            if (chatContainer && chatContainer.style.display !== 'none' && standaloneContainer) {
                const chatPreviewContainer = document.getElementById('chatPreviewContainer');
                if (chatPreviewContainer) {
                    chatPreviewContainer.innerHTML = standaloneContainer.innerHTML;
                    renderCarouselInContainer(chatPreviewContainer);
                    
                    // Re-attach event handlers to cloned See More links
                    chatPreviewContainer.querySelectorAll('.see-more-link, .see-more-button-full, .see-more-card-inner').forEach(el => {
                        if (el.classList.contains('see-more-card-inner')) {
                            el.onclick = handleSeeMore;
                        } else {
                            el.setAttribute('onclick', 'handleSeeMore(event)');
                            el.setAttribute('href', '#');
                        }
                    });
                    // Re-attach nudge chip handlers (initial row + all turn rows)
                    chatPreviewContainer.querySelectorAll('.nudge-chip').forEach(chip => {
                        const origOnclick = chip.getAttribute('onclick');
                        if (origOnclick) chip.setAttribute('onclick', origOnclick);
                    });
                    // Re-attach carousel nav buttons
                    const chatPrev = chatPreviewContainer.querySelector('#prevBtn');
                    const chatNext = chatPreviewContainer.querySelector('#nextBtn');
                    if (chatPrev) chatPrev.setAttribute('onclick', 'handlePrevious()');
                    if (chatNext) chatNext.setAttribute('onclick', 'handleNext()');
                    // Re-attach pagination dots
                    chatPreviewContainer.querySelectorAll('.pagination-dot').forEach((dot, i) => {
                        dot.setAttribute('onclick', `goToSlide(${i})`);
                    });
                    // Re-attach sub-carousel buttons
                    chatPreviewContainer.querySelectorAll('.sub-carousel-nav-btn').forEach(btn => {
                        const origOnclick = btn.getAttribute('onclick');
                        if (origOnclick) btn.setAttribute('onclick', origOnclick);
                    });
                    // Re-attach Quick View buttons
                    chatPreviewContainer.querySelectorAll('.btn-quick-view').forEach(btn => {
                        const onclick = btn.getAttribute('onclick');
                        if (onclick) {
                            // Extract product ID from onclick attribute
                            const match = onclick.match(/handleQuickView\('([^']+)'\)/);
                            if (match) {
                                btn.setAttribute('onclick', `handleQuickView('${match[1]}')`);
                            }
                        }
                    });
                }
            }
        }

        // Internal reset (used when switching disclosure/placement, NOT exposed to user)
        function resetDisclosure() {
            isExpanded = false;
            turnCounter = 0;
            Object.keys(turnCarouselIndices).forEach(k => delete turnCarouselIndices[k]);
            Object.keys(turnData).forEach(k => delete turnData[k]);
            $id('expandedGrid').classList.remove('visible');
            $id('expandedGrid').innerHTML = '';
            $id('scrollableList').classList.remove('visible');
            $id('scrollableList').innerHTML = '';
            $id('stackedCarousels').classList.remove('visible');
            $id('stackedCarousels').innerHTML = '';
            $id('carouselSection').classList.remove('hidden');
            $id('conversationThread').innerHTML = '';
            hideNudgeChips();
        }

        // Disclosure 2: Extend carousel (one-way)
        function extendCarousel() {
            allProducts = [...mockProducts, ...extraProducts];
            TOTAL_DOTS = allProducts.length + (activePlacement === 'c' ? 1 : 0);
            renderCarousel();
        }

        // Disclosure 4: List view (one-way)
        function showListView() {
            const list = $id('scrollableList');
            const allItems = [...mockProducts, ...extraProducts];
            list.innerHTML = allItems.map(p => `
                <a href="${p.productUrl}" target="_blank" rel="noopener noreferrer" class="list-item">
                    <img src="${p.imageUrl}" class="list-item-img" alt="${p.name}"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/52x52/fafaf9/706e6b?text=...';">
                    <div class="list-item-info">
                        <div class="list-item-name">${p.name}</div>
                        <div class="list-item-price">${formatPrice(p.price)}</div>
                    </div>
                    <span class="list-item-arrow">&rsaquo;</span>
                </a>
            `).join('');
            list.classList.add('visible');
            $id('carouselSection').classList.add('hidden');
        }

        // Disclosure 5: Stacked carousels
        // State for each sub-carousel
        const subCarouselIndices = {};
        
        function renderSubCarousel(categoryIndex, cat) {
            const carouselId = `subCarousel_${categoryIndex}`;
            const currentIdx = subCarouselIndices[carouselId] || 0;
            const products = cat.products;
            const totalDots = products.length; // 5 products = 5 dots (overlapping like main carousel)
            
            // Get visible products (2 at a time, overlapping)
            const visibleProducts = [];
            for (let i = 0; i < 2; i++) {
                const idx = (currentIdx + i) % products.length;
                visibleProducts.push(products[idx]);
            }
            
            const dots = Array.from({ length: totalDots }, (_, i) => 
                `<button class="sub-dot ${i === currentIdx ? 'active' : ''}" 
                         onclick="goToSubCarouselSlide(${categoryIndex}, ${i})"
                         aria-label="Go to slide ${i + 1}"></button>`
            ).join('');
            
            const canGoPrev = currentIdx > 0;
            const canGoNext = currentIdx < totalDots - 1;
            
            return `
                <div>
                    <div class="sub-carousel-header">${cat.title}</div>
                    <div class="sub-carousel-wrapper">
                        <button class="sub-carousel-nav-btn" onclick="subCarouselPrev(${categoryIndex})" ${canGoPrev ? '' : 'disabled'}>&lsaquo;</button>
                        <div class="sub-carousel-track">
                            ${visibleProducts.map(renderProductCard).join('')}
                        </div>
                        <button class="sub-carousel-nav-btn" onclick="subCarouselNext(${categoryIndex})" ${canGoNext ? '' : 'disabled'}>&rsaquo;</button>
                    </div>
                    <div class="sub-carousel-nav">
                        ${dots}
                    </div>
                </div>`;
        }
        
        function subCarouselPrev(categoryIndex) {
            const carouselId = `subCarousel_${categoryIndex}`;
            const currentIdx = subCarouselIndices[carouselId] || 0;
            if (currentIdx > 0) {
                subCarouselIndices[carouselId] = currentIdx - 1;
                updateSubCarousel(categoryIndex);
            }
        }
        
        function subCarouselNext(categoryIndex) {
            const carouselId = `subCarousel_${categoryIndex}`;
            const cat = subCategories[categoryIndex];
            const currentIdx = subCarouselIndices[carouselId] || 0;
            const totalDots = cat.products.length;
            if (currentIdx < totalDots - 1) {
                subCarouselIndices[carouselId] = currentIdx + 1;
                updateSubCarousel(categoryIndex);
            }
        }
        
        function goToSubCarouselSlide(categoryIndex, slideIndex) {
            const carouselId = `subCarousel_${categoryIndex}`;
            subCarouselIndices[carouselId] = slideIndex;
            updateSubCarousel(categoryIndex);
        }
        
        function updateSubCarousel(categoryIndex) {
            const container = $id('stackedCarousels');
            const cat = subCategories[categoryIndex];
            const carouselHtml = renderSubCarousel(categoryIndex, cat);
            // Find and replace the specific carousel
            const carousels = container.querySelectorAll(':scope > div');
            if (carousels[categoryIndex]) {
                carousels[categoryIndex].outerHTML = carouselHtml;
            }
            syncChatContainer();
        }
        
        // Disclosure 5: Stacked carousels (one-way)
        function showStackedCarousels() {
            const container = $id('stackedCarousels');
            if (!container) return;

            // Reset all sub-carousel indices
            subCategories.forEach((_, idx) => {
                subCarouselIndices[`subCarousel_${idx}`] = 0;
            });

            container.innerHTML = subCategories.map((cat, idx) => renderSubCarousel(idx, cat)).join('');
            container.classList.add('visible');
        }
        
        // Make functions globally accessible
        window.subCarouselPrev = subCarouselPrev;
        window.subCarouselNext = subCarouselNext;
        window.goToSubCarouselSlide = goToSubCarouselSlide;
        window.handleSeeMore = handleSeeMore;

        // ===== PLACEMENT / DISCLOSURE TOGGLING =====
        function applyPlacement(value) {
            // Reset any open disclosure
            resetDisclosure();
            allProducts = [...mockProducts];

            activePlacement = value;
            // Hide all placement elements (A, B are separate UI elements)
            getStandalone().querySelectorAll('.see-more-a, .see-more-b').forEach(el => {
                el.classList.add('is-hidden');
            });

            if (value === 'c') {
                TOTAL_DOTS = 6; // 5 products + 1 See More card
            } else {
                TOTAL_DOTS = 5;
            }
            
            // Show selected placement element (A or B)
            if (value !== 'c') {
                getStandalone().querySelectorAll(`.see-more-${value}`).forEach(el => {
                    el.classList.remove('is-hidden');
                });
            }
            
            // Reset carousel index if needed
            currentIndex = 0;
            
            // Update selected state in panel
            document.querySelectorAll('[data-placement]').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.placement === value);
            });
            
            renderCarousel();
            syncChatContainer();
            renderUxExplanations();
        }

        function applyDisclosure(value) {
            // Reset any open disclosure first
            resetDisclosure();
            // Reset carousel to original products
            allProducts = [...mockProducts];
            // Set TOTAL_DOTS based on active placement
            TOTAL_DOTS = activePlacement === 'c' ? 6 : 5;
            currentIndex = 0;

            // Re-show See More elements for the active placement
            if (activePlacement !== 'c') {
                getStandalone().querySelectorAll(`.see-more-${activePlacement}`).forEach(el => {
                    el.classList.remove('is-hidden');
                });
            }

            renderCarousel();

            activeDisclosure = value;
            // Update selected state in panel
            document.querySelectorAll('[data-disclosure]').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.disclosure === value);
            });
            
            syncChatContainer();
            renderUxExplanations();
        }

        // Wire up radio buttons
        document.querySelectorAll('input[name="placement"]').forEach(radio => {
            radio.addEventListener('change', () => applyPlacement(radio.value));
        });
        document.querySelectorAll('input[name="disclosure"]').forEach(radio => {
            radio.addEventListener('change', () => applyDisclosure(radio.value));
        });

        // ===== PROTOTYPE MODE & DEVICE TOGGLE =====
        let activeDevice = 'mobile';

        function togglePrototypeMode(enabled) {
            const chatContainer = document.getElementById('chatContainer');
            const standaloneContainer = document.getElementById('standaloneContainer');
            const previewArea = document.getElementById('previewArea');
            const deviceSection = document.getElementById('deviceToggleSection');

            if (enabled) {
                // Sync chat content from standalone into chatPreview
                const chatPreviewContainer = document.getElementById('chatPreviewContainer');
                chatPreviewContainer.innerHTML = standaloneContainer.innerHTML;

                standaloneContainer.style.display = 'none';
                previewArea.classList.add('prototype-mode');
                deviceSection.style.display = 'block';
                renderUxExplanations();

                // Apply the currently selected device mode
                applyDeviceMode(activeDevice);
            } else {
                // Move chatContainer back to previewArea (before standaloneContainer)
                previewArea.insertBefore(chatContainer, standaloneContainer);
                chatContainer.style.display = 'none';

                document.getElementById('mobileFrame').style.display = 'none';
                document.getElementById('desktopFrame').style.display = 'none';
                previewArea.classList.remove('prototype-mode');
                previewArea.classList.remove('device-mobile');
                previewArea.classList.remove('device-desktop');

                standaloneContainer.style.display = 'block';
                deviceSection.style.display = 'none';

                // Reset message animations
                document.querySelectorAll('.chat-message').forEach(msg => {
                    msg.classList.remove('visible');
                });

                renderUxExplanations();
            }
        }

        function applyDeviceMode(mode) {
            activeDevice = mode;
            const chatContainer = document.getElementById('chatContainer');
            const mobileFrame = document.getElementById('mobileFrame');
            const desktopFrame = document.getElementById('desktopFrame');
            const previewArea = document.getElementById('previewArea');

            // Reset message animations before moving
            document.querySelectorAll('.chat-message').forEach(msg => {
                msg.classList.remove('visible');
            });

            // Update settings panel selection
            document.querySelectorAll('[data-device]').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.device === mode);
            });

            if (mode === 'mobile') {
                desktopFrame.style.display = 'none';
                // Restore desktop sidebar in case it was minimized
                document.getElementById('desktopSidebar').style.display = 'flex';
                document.getElementById('desktopMinimizedFab').style.display = 'none';
                // Restore mobile elements
                document.getElementById('mobileHeaderBar').style.display = 'flex';
                document.getElementById('mobileScreenBody').style.display = 'flex';
                document.getElementById('mobileScreen').querySelector('.mobile-input-bar').style.display = 'block';
                document.getElementById('mobileMinimizedFab').style.display = 'none';
                document.getElementById('mobileScreenBody').appendChild(chatContainer);
                chatContainer.style.display = 'flex';
                mobileFrame.style.display = 'flex';
                previewArea.classList.remove('device-desktop');
                previewArea.classList.add('device-mobile');
            } else {
                mobileFrame.style.display = 'none';
                // Restore mobile in case it was minimized
                document.getElementById('mobileMinimizedFab').style.display = 'none';
                // Restore desktop sidebar
                const sidebar = document.getElementById('desktopSidebar');
                sidebar.style.display = 'flex';
                document.getElementById('desktopMinimizedFab').style.display = 'none';
                const inputBar = document.getElementById('sidebarInputBar');
                sidebar.insertBefore(chatContainer, inputBar);
                chatContainer.style.display = 'flex';
                desktopFrame.style.display = 'flex';
                previewArea.classList.remove('device-mobile');
                previewArea.classList.add('device-desktop');
            }

            syncChatContainer();
            setTimeout(() => animateChatMessages(), 300);
        }

        // ===== CHAT HEADER: Menu & Minimize =====
        // Toggle the "End Chat" dropdown on â‹® click
        document.querySelectorAll('.chat-menu-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = btn.closest('.chat-header-bar').querySelector('.chat-header-menu');
                if (menu) menu.classList.toggle('visible');
            });
        });
        // Close menu when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.chat-header-menu.visible').forEach(m => m.classList.remove('visible'));
        });

        // Minimize âŒ„: hide sidebar/chat, show Olive FAB
        document.querySelectorAll('.chat-minimize-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (activeDevice === 'desktop') {
                    const sidebar = document.getElementById('desktopSidebar');
                    const fab = document.getElementById('desktopMinimizedFab');
                    sidebar.style.display = 'none';
                    if (fab) fab.style.display = 'flex';
                } else if (activeDevice === 'mobile') {
                    const screenBody = document.getElementById('mobileScreenBody');
                    const header = document.getElementById('mobileHeaderBar');
                    const inputBar = document.getElementById('mobileScreen').querySelector('.mobile-input-bar');
                    const fab = document.getElementById('mobileMinimizedFab');
                    if (screenBody) screenBody.style.display = 'none';
                    if (header) header.style.display = 'none';
                    if (inputBar) inputBar.style.display = 'none';
                    if (fab) fab.style.display = 'flex';
                }
            });
        });

        // Restore from minimized FAB
        window.restoreChat = function(device) {
            if (device === 'desktop') {
                const sidebar = document.getElementById('desktopSidebar');
                const fab = document.getElementById('desktopMinimizedFab');
                sidebar.style.display = 'flex';
                if (fab) fab.style.display = 'none';
            } else {
                const screenBody = document.getElementById('mobileScreenBody');
                const header = document.getElementById('mobileHeaderBar');
                const inputBar = document.getElementById('mobileScreen').querySelector('.mobile-input-bar');
                const fab = document.getElementById('mobileMinimizedFab');
                if (screenBody) screenBody.style.display = 'flex';
                if (header) header.style.display = 'flex';
                if (inputBar) inputBar.style.display = 'block';
                if (fab) fab.style.display = 'none';
            }
        };

        // End Chat handler (placeholder)
        window.handleEndChat = function() {
            document.querySelectorAll('.chat-header-menu.visible').forEach(m => m.classList.remove('visible'));
            alert('Chat ended. (This is a prototype â€” no actual session to end.)');
        };

        function renderCarouselInContainer(container) {
            if (!container) return;
            
            const track = container.querySelector('#carouselTrack');
            if (track) {
                const items = getVisibleItems();
                track.innerHTML = items.map(item => 
                    item.type === 'seeMore' ? renderSeeMoreCard() : renderProductCard(item.product)
                ).join('');
            }
            
            // Update navigation buttons
            const prevBtn = container.querySelector('#prevBtn');
            const nextBtn = container.querySelector('#nextBtn');
            if (prevBtn) prevBtn.disabled = currentIndex === 0;
            if (nextBtn) nextBtn.disabled = currentIndex >= TOTAL_DOTS - 1;
            
            // Update pagination dots
            const paginationDots = container.querySelector('#paginationDots');
            if (paginationDots) {
                paginationDots.innerHTML = Array.from({ length: TOTAL_DOTS }, (_, i) =>
                    `<button class="pagination-dot ${i === currentIndex ? 'active' : ''}" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}"></button>`
                ).join('');
            }
            
            // Update See More elements visibility based on active placement
            if (!isExpanded) {
                if (activePlacement === 'a') {
                    container.querySelectorAll('.see-more-a').forEach(el => el.classList.remove('is-hidden'));
                    container.querySelectorAll('.see-more-b').forEach(el => el.classList.add('is-hidden'));
                } else if (activePlacement === 'b') {
                    container.querySelectorAll('.see-more-b').forEach(el => el.classList.remove('is-hidden'));
                    container.querySelectorAll('.see-more-a').forEach(el => el.classList.add('is-hidden'));
                } else {
                    container.querySelectorAll('.see-more-a, .see-more-b').forEach(el => el.classList.add('is-hidden'));
                }
            } else {
                container.querySelectorAll('.see-more-a, .see-more-b').forEach(el => el.classList.add('is-hidden'));
            }
        }

        function animateChatMessages() {
            const messages = document.querySelectorAll('.chat-message');
            messages.forEach((msg, idx) => {
                setTimeout(() => {
                    msg.classList.add('visible');
                }, idx * 400);
            });
        }

        // Wire up prototype mode toggle
        const prototypeToggle = document.getElementById('prototypeModeToggle');
        if (prototypeToggle) {
            prototypeToggle.addEventListener('change', (e) => {
                togglePrototypeMode(e.target.checked);
            });
        }

        // Wire up device toggle
        document.querySelectorAll('input[name="device"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (document.getElementById('prototypeModeToggle').checked) {
                    applyDeviceMode(radio.value);
                }
            });
        });

        // ===== UX EXPLANATIONS =====
        const uxPlacementData = {
            a: {
                icon: 'ðŸ”—', title: 'Header-Right Link',
                desc: 'A subtle text link positioned in the header row beside the section title. Commonly used in editorial and content-heavy layouts.',
                pros: ['Minimal footprint â€” doesn\'t disrupt layout', 'Familiar web pattern (inline links)', 'Space-efficient, works with any header style', 'Feels non-intrusive for returning visitors'],
                cons: ['Low visibility â€” easy to overlook', 'Low affordance (text link vs. button)', 'Small tap target on mobile devices', 'May underperform for first-time users who need discovery'],
                bestPractice: 'Best for power users or when "See More" is a secondary action. To improve discoverability, use a distinct color and underline on hover. Pair with a bolder disclosure on first visit.'
            },
            b: {
                icon: 'ðŸ”˜', title: 'Full-Width Button',
                desc: 'A prominent outlined button below the carousel navigation. This is a standard e-commerce CTA pattern with high visibility.',
                pros: ['High visibility â€” impossible to miss', 'Strong affordance (button = clickable)', 'Large tap target on mobile', 'Clear, actionable CTA that drives engagement'],
                cons: ['Takes extra vertical space', 'Can feel aggressive/pushy if overused', 'May compete visually with product cards', 'Adds visual weight below the carousel'],
                bestPractice: 'Best overall choice for driving discovery. Place below the carousel where users naturally look after browsing. Use outlined (not filled) style to feel inviting without overpowering product cards.'
            },
            c: {
                icon: 'ðŸƒ', title: 'See More Card in Carousel',
                desc: 'The "See More" action appears as the last card in the carousel, discoverable during the natural browsing flow.',
                pros: ['Contextual â€” discovered while browsing', 'No extra UI elements or layout shifts', 'Maintains the carousel paradigm', 'Feels integrated and non-intrusive'],
                cons: ['User may never scroll far enough to see it', 'Competes with product cards for attention', 'Breaks expectation that all cards are products', 'Pagination dots may not convey a CTA exists'],
                bestPractice: 'Works well when users are actively engaged with the carousel. Consider adding a visual indicator (e.g., a different card color or arrow icon) to differentiate it from product cards.'
            }
        };

        const uxDisclosureData = {
            '1': {
                icon: 'ðŸ“š', title: 'Stacked Carousels by Category',
                desc: 'Reveals additional mini-carousels grouped by sub-category (e.g., Espresso Machines, Coffee Grinders). Each has its own navigation.',
                pros: ['Organized by meaningful categories', 'Enables focused browsing within each group', 'Maintains carousel interaction per group', 'Feels like structured recommendations'],
                cons: ['Takes significant vertical space', 'Can feel overwhelming (multiple carousels at once)', 'Harder to compare across categories', 'Each carousel requires its own navigation state'],
                bestPractice: 'Best when products span distinct categories and the AI wants to suggest related product types. Limit to 2-3 sub-carousels. Each should have a clear heading explaining the recommendation logic.'
            },
            '2': {
                icon: 'ðŸ“Š', title: 'Expand Grid Below',
                desc: 'Additional products appear in a 2-column grid below the carousel. The original carousel stays visible, providing context.',
                pros: ['Preserves original carousel context', 'Users see both initial picks and expanded results', 'Familiar expand/collapse pattern', 'Good for progressive disclosure â€” conversation builds downward'],
                cons: ['Pushes content below the fold', 'Increases page length and scrolling', 'User may lose their scroll position', 'Can feel overwhelming if too many items are shown'],
                bestPractice: 'Best for progressive disclosure in conversational AI. Keeps context visible while revealing more. Limit expanded items to 4-6 to prevent overload. Pair with nudge chips for guided refinement.'
            },
            '3': {
                icon: 'âž•', title: 'Carousel Extends',
                desc: 'More products load directly into the carousel, adding extra pagination dots. The interaction pattern remains consistent.',
                pros: ['Seamless â€” no layout changes', 'Consistent interaction (same carousel gestures)', 'Minimal cognitive load', 'No content shift or page reflow'],
                cons: ['Hard to notice items were added', 'Old vs. new items are indistinguishable', 'Pagination dots can get crowded (7+ dots)', 'Feels less like "discovery" and more invisible'],
                bestPractice: 'Works best when additions are modest (2-4 items). Signal the change clearly â€” e.g., briefly highlight the new dots or show a toast. Not ideal for large product sets.'
            },
            '4': {
                icon: 'â†—ï¸', title: 'Open Product Page',
                desc: 'Clicking "See More" opens the Williams-Sonoma category page in a new tab. No in-chat expansion occurs.',
                pros: ['Full e-commerce browsing experience', 'Leverages existing WS product pages', 'No additional chat complexity', 'Good for "browse at your own pace" users'],
                cons: ['Leaves the conversation entirely', 'Loses AI context and history', 'User must navigate back to chat', 'Breaks the conversational flow the AI built'],
                bestPractice: 'Use as a fallback "escape hatch" alongside another disclosure pattern, not as the primary action. Best when paired with a "Browse All" link at the end of a conversation, after initial guided exploration.'
            },
            '5': {
                icon: 'ðŸ“‹', title: 'Replace with List View',
                desc: 'The carousel switches to a compact scrollable list view. Products are shown in a scannable row format with thumbnail, name, and price.',
                pros: ['Compact â€” shows more products in less space', 'Highly scannable (one product per row)', 'Efficient for quick comparison', 'Good information density for mobile'],
                cons: ['Loses visual richness of product images', 'Less engaging than card/carousel view', 'Removes the carousel (can\'t go back easily)', 'Not ideal for visual products (fashion, decor)'],
                bestPractice: 'Best for utility-focused browsing where users want to quickly scan options (e.g., accessories, tools). For visually-driven categories (furniture, fashion), the grid or carousel is preferable.'
            }
        };

        // ===== RIGHT RAIL TOGGLE =====
        let uxRailOpen = true;
        const uxRail = document.getElementById('uxRail');
        const uxRailToggle = document.getElementById('uxRailToggle');
        uxRailToggle.addEventListener('click', () => {
            uxRailOpen = !uxRailOpen;
            uxRail.classList.toggle('collapsed', !uxRailOpen);
            uxRailToggle.innerHTML = uxRailOpen ? '&#x276F;' : '&#x276E;';
            uxRailToggle.title = uxRailOpen ? 'Collapse UX commentary' : 'Expand UX commentary';
        });

        function renderUxExplanations() {
            const panel = document.getElementById('uxExplanations');
            if (!panel) return;
            const rail = document.getElementById('uxRail');
            const isProto = document.getElementById('prototypeModeToggle').checked;
            if (isProto) { rail.classList.add('is-hidden'); return; }
            rail.classList.remove('is-hidden');

            const p = uxPlacementData[activePlacement];
            const d = uxDisclosureData[activeDisclosure];

            panel.innerHTML = renderUxCard(p, 'placement', 'Placement ' + activePlacement.toUpperCase()) + renderUxCard(d, 'disclosure', 'Disclosure ' + activeDisclosure);
        }

        function renderUxCard(data, type, label) {
            return `
            <div class="ux-card">
                <div class="ux-card-header">
                    <span class="ux-card-icon">${data.icon}</span>
                    <span class="ux-card-title">${data.title}</span>
                    <span class="ux-card-label ${type}">${label}</span>
                </div>
                <div class="ux-card-desc">${data.desc}</div>
                <div class="ux-pro-con">
                    <div class="ux-pro">
                        <div class="ux-pro-title">Pros</div>
                        <ul>${data.pros.map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                    <div class="ux-con">
                        <div class="ux-con-title">Cons</div>
                        <ul>${data.cons.map(c => `<li>${c}</li>`).join('')}</ul>
                    </div>
                </div>
                <div class="ux-best-practice">
                    <strong>UX Best Practice</strong>
                    ${data.bestPractice}
                </div>
            </div>`;
        }

        // ===== QUICK VIEW HANDLERS =====
        function getProductById(id) {
            return [...mockProducts, ...extraProducts].find(p => p.id === id);
        }

        function renderQuickViewContent(product) {
            const highlights = product.highlights || [];
            const rating = product.rating || 4.5;
            const reviewCount = product.reviewCount || 0;
            const stars = 'â˜…'.repeat(Math.floor(rating)) + 'â˜†'.repeat(5 - Math.floor(rating));
            
            return `
                <img src="${product.imageUrl}" alt="${product.name}" class="quick-view-image-large"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/fafaf9/706e6b?text=Coffee+Maker';">
                <h3 class="quick-view-product-name">${product.name}</h3>
                <div class="quick-view-price">${formatPrice(product.price)}</div>
                ${product.description ? `<div class="quick-view-card-details">${product.description}</div>` : ''}
                ${rating > 0 ? `<div class="quick-view-rating"><span class="quick-view-stars">${stars}</span> <span>${rating} (${reviewCount} reviews)</span></div>` : ''}
                ${highlights.length > 0 ? `
                    <div class="quick-view-highlights">
                        <div class="quick-view-highlights-title">Key Features</div>
                        <ul class="quick-view-highlights-list">
                            ${highlights.map(h => `<li>${h}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                <div class="quick-view-actions">
                    <button class="btn-add-to-cart" onclick="alert('Added to cart! (Prototype)')">Add to Cart</button>
                    <a href="${product.productUrl}" target="_blank" class="btn-view-details">View Full Details</a>
                </div>
            `;
        }

        function handleQuickView(productId) {
            const product = getProductById(productId);
            if (!product) return;

            // Route to appropriate Quick View function based on CTA pattern
            if (activeCtaPattern === 'e') {
                showQuickViewInChatMessage(product);
            } else {
                showQuickViewSidePanel(product);
            }
        }

        function showQuickViewSidePanel(product) {
            activeQuickView = product;
            quickViewType = 'sidePanel';
            
            // Determine the correct parent container based on current mode
            let parentContainer = null;
            const isProto = document.getElementById('prototypeModeToggle')?.checked;
            const mobileFrame = document.getElementById('mobileFrame');
            const desktopSidebar = document.getElementById('desktopSidebar');
            
            if (isProto && mobileFrame && mobileFrame.style.display !== 'none') {
                // Mobile prototype mode - append to phone-screen
                parentContainer = document.getElementById('mobileScreen');
            } else if (isProto && desktopSidebar && desktopSidebar.style.display !== 'none') {
                // Desktop prototype mode - append to desktop-sidebar
                parentContainer = desktopSidebar;
            } else {
                // Standalone mode - append to standaloneContainer or preview-container
                parentContainer = document.getElementById('standaloneContainer') || 
                                 document.querySelector('.preview-container');
            }
            
            if (!parentContainer) return;
            
            // Find or create Quick View container
            let qvContainer = parentContainer.querySelector('.quick-view-container');
            if (!qvContainer) {
                qvContainer = document.createElement('div');
                qvContainer.className = 'quick-view-container';
                parentContainer.appendChild(qvContainer);
                
                // Move overlay and panel into container if they exist, or create them
                const existingOverlay = document.getElementById('quickViewOverlay');
                const existingPanel = document.getElementById('quickViewSidePanel');
                
                if (existingOverlay && existingPanel) {
                    qvContainer.appendChild(existingOverlay);
                    qvContainer.appendChild(existingPanel);
                } else {
                    // Create new overlay and panel
                    qvContainer.innerHTML = `
                        <div class="quick-view-overlay" id="quickViewOverlay" onclick="closeQuickView()"></div>
                        <div class="quick-view-side-panel" id="quickViewSidePanel" onclick="event.stopPropagation()">
                            <div class="quick-view-panel-header">
                                <div class="quick-view-panel-title" id="quickViewPanelTitle">Quick View</div>
                                <button class="quick-view-close" onclick="closeQuickView()">&times;</button>
                            </div>
                            <div class="quick-view-panel-body" id="quickViewPanelBody"></div>
                        </div>
                    `;
                }
            }
            
            const overlay = qvContainer.querySelector('.quick-view-overlay');
            const panel = qvContainer.querySelector('.quick-view-side-panel');
            const body = qvContainer.querySelector('.quick-view-panel-body');
            
            if (!overlay || !panel || !body) return;
            
            // Ensure container is visible
            qvContainer.style.display = 'block';
            
            body.innerHTML = renderQuickViewContent(product);
            
            overlay.classList.add('visible');
            setTimeout(() => panel.classList.add('visible'), 10);
            
            // Close on ESC key
            document.addEventListener('keydown', handleQuickViewEsc);
        }

        function showQuickViewCard(product) {
            activeQuickView = product;
            quickViewType = 'card';
            
            // Find the product card and expand it
            const card = document.querySelector(`.product-card[data-product-id="${product.id}"]`);
            if (card) {
                const cardInner = card.querySelector('.product-card-inner');
                if (cardInner) {
                    cardInner.classList.add('expanded');
                    let contentDiv = cardInner.querySelector('.quick-view-card-content');
                    if (!contentDiv) {
                        contentDiv = document.createElement('div');
                        contentDiv.className = 'quick-view-card-content';
                        cardInner.appendChild(contentDiv);
                    }
                    const highlights = product.highlights || [];
                    const rating = product.rating || 4.5;
                    const reviewCount = product.reviewCount || 0;
                    const stars = 'â˜…'.repeat(Math.floor(rating)) + 'â˜†'.repeat(5 - Math.floor(rating));
                    
                    contentDiv.innerHTML = `
                        <img src="${product.imageUrl}" alt="${product.name}" class="quick-view-card-image"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/fafaf9/706e6b?text=Coffee+Maker';">
                        ${product.description ? `<div class="quick-view-card-details">${product.description}</div>` : ''}
                        ${rating > 0 ? `<div class="quick-view-rating"><span class="quick-view-stars">${stars}</span> <span>${rating} (${reviewCount} reviews)</span></div>` : ''}
                        ${highlights.length > 0 ? `
                            <div class="quick-view-highlights">
                                <div class="quick-view-highlights-title">Key Features</div>
                                <ul class="quick-view-highlights-list">
                                    ${highlights.map(h => `<li>${h}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="quick-view-actions">
                            <button class="btn-add-to-cart" onclick="alert('Added to cart! (Prototype)')">Add to Cart</button>
                            <a href="${product.productUrl}" target="_blank" class="btn-view-details">View Full Details</a>
                            <button class="btn-quick-view" onclick="closeQuickView()" style="margin-top:0.5rem;">Close</button>
                        </div>
                    `;
                }
            }
        }

        function showQuickViewInChatMessage(product) {
            activeQuickView = product;
            quickViewType = 'inChatMessage';
            
            const highlights = product.highlights || [];
            const rating = product.rating || 4.5;
            const reviewCount = product.reviewCount || 0;
            const stars = 'â˜…'.repeat(Math.floor(rating)) + 'â˜†'.repeat(5 - Math.floor(rating));
            
            // Determine where to append - prefer conversationThread, fallback to chatContainer
            let targetContainer = $id('conversationThread');
            if (!targetContainer) {
                targetContainer = $id('chatContainer');
            }
            if (!targetContainer) {
                // Fallback to standaloneContainer if neither exists
                targetContainer = $id('standaloneContainer');
            }
            
            if (!targetContainer) return;
            
            // Create the message HTML
            const messageId = `qv-in-chat-${product.id}-${Date.now()}`;
            const messageHtml = `
                <div class="chat-message agent quick-view-in-chat-message" data-quick-view-message="${messageId}">
                    <div class="chat-avatar"><img src="https://wsgc.my.site.com/ESWSousChefAgentOlive1760167198695vforce/resource/AgentOliveIcon" alt="Agent Olive"></div>
                    <div class="message-content">
                        <div class="quick-view-in-chat-card">
                            <img src="${product.imageUrl}" alt="${product.name}" class="quick-view-in-chat-image"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/fafaf9/706e6b?text=Coffee+Maker';">
                            <h3 class="quick-view-in-chat-name">${product.name}</h3>
                            <div class="quick-view-in-chat-price">${formatPrice(product.price)}</div>
                            ${product.description ? `<div class="quick-view-in-chat-description">${product.description}</div>` : ''}
                            ${rating > 0 ? `<div class="quick-view-in-chat-rating"><span class="quick-view-stars">${stars}</span> <span>${rating} (${reviewCount} reviews)</span></div>` : ''}
                            ${highlights.length > 0 ? `
                                <div class="quick-view-in-chat-highlights">
                                    <div class="quick-view-in-chat-highlights-title">Key Features</div>
                                    <ul class="quick-view-in-chat-highlights-list">
                                        ${highlights.map(h => `<li>${h}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <div class="quick-view-in-chat-actions">
                                <button class="btn-add-to-cart" onclick="alert('Added to cart! (Prototype)')">Add to Cart</button>
                                <a href="${product.productUrl}" target="_blank" class="btn-view-details">View Full Details</a>
                                <button class="quick-view-in-chat-close" onclick="closeQuickView()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append to container
            targetContainer.insertAdjacentHTML('beforeend', messageHtml);
            
            // Make it visible with animation
            const newMessage = targetContainer.querySelector(`[data-quick-view-message="${messageId}"]`);
            if (newMessage) {
                setTimeout(() => {
                    newMessage.classList.add('visible');
                }, 10);
            }
            
            // Sync chat container and scroll
            syncChatContainer();
            autoScrollToLatestTurn();
        }

        function showQuickViewModal(product) {
            activeQuickView = product;
            quickViewType = 'modal';
            
            const overlay = document.getElementById('quickViewOverlay');
            const modal = document.getElementById('quickViewModal');
            const body = document.getElementById('quickViewModalBody');
            
            body.innerHTML = renderQuickViewContent(product);
            
            overlay.classList.add('visible');
            setTimeout(() => modal.classList.add('visible'), 10);
            
            // Close on ESC key
            document.addEventListener('keydown', handleQuickViewEsc);
        }

        function handleQuickViewEsc(e) {
            if (e.key === 'Escape') {
                closeQuickView();
            }
        }

        function closeQuickView() {
            activeQuickView = null;
            quickViewType = null;
            
            // Find and close all visible side panels first (animate out)
            const visiblePanels = document.querySelectorAll('.quick-view-side-panel.visible');
            visiblePanels.forEach(panel => {
                panel.classList.remove('visible');
            });
            
            // Find and close all visible overlays after panel animation
            setTimeout(() => {
                const visibleOverlays = document.querySelectorAll('.quick-view-overlay.visible');
                visibleOverlays.forEach(overlay => {
                    overlay.classList.remove('visible');
                });
                
                // Hide all Quick View containers after animation completes
                document.querySelectorAll('.quick-view-container').forEach(container => {
                    container.style.display = 'none';
                });
            }, 350);
            
            // Handle modal (uses fixed overlay)
            const modal = document.getElementById('quickViewModal');
            if (modal && modal.classList.contains('visible')) {
                modal.classList.remove('visible');
                const modalOverlay = document.getElementById('quickViewOverlay');
                if (modalOverlay && modalOverlay.classList.contains('visible')) {
                    setTimeout(() => modalOverlay.classList.remove('visible'), 300);
                }
            }
            
            // Remove expanded state from cards
            document.querySelectorAll('.product-card-inner.expanded').forEach(card => {
                card.classList.remove('expanded');
            });
            
            // Remove in-chat Quick View messages
            document.querySelectorAll('.quick-view-in-chat-message').forEach(message => {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    message.remove();
                }, 300);
            });
            
            document.removeEventListener('keydown', handleQuickViewEsc);
        }

        // Expose globally for onclick handlers
        window.handleQuickView = handleQuickView;
        window.closeQuickView = closeQuickView;
        window.showQuickViewSidePanel = showQuickViewSidePanel;
        window.showQuickViewCard = showQuickViewCard;
        window.showQuickViewModal = showQuickViewModal;
        window.showQuickViewInChatMessage = showQuickViewInChatMessage;

        // ===== CTA PATTERN HANDLER =====
        function applyCtaPattern(value) {
            activeCtaPattern = value;
            // Close any open Quick View when switching patterns
            if (activeQuickView) {
                closeQuickView();
            }
            // Update selected state in panel
            document.querySelectorAll('[data-cta]').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.cta === value);
            });
            // Re-render carousel to update buttons
            renderCarousel();
            syncChatContainer();
        }

        // Wire up CTA pattern radio buttons
        document.querySelectorAll('input[name="cta"]').forEach(radio => {
            radio.addEventListener('change', () => applyCtaPattern(radio.value));
        });

        // ===== INIT =====
        // Initialize with default placement, disclosure, and CTA pattern
        applyPlacement('a');
        applyDisclosure('1');
        applyCtaPattern('d');
        renderCarousel();
        renderUxExplanations();
    </script>
</body>
</html>
